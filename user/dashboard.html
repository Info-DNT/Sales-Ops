<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sales Ops</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
    <div id="app">
        <!-- Sidebar will be inserted here -->

        <div class="main-content">
            <div class="page-header">
                <h2>Home Dashboard</h2>
                <button class="btn btn-primary d-none-quotation" data-bs-toggle="modal"
                    data-bs-target="#quotationModal">
                    <i class="fas fa-file-invoice-dollar"></i> Request Quotation
                </button>
            </div>

            <div class="dashboard-grid">
                <!-- Stats Cards -->
                <div class="stat-card">
                    <div class="stat-icon attendance">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h6>Today's Status</h6>
                        <p id="attendance-status">Loading...</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon leads">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="stat-content">
                        <h6>Total Leads</h6>
                        <p id="total-leads">0</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon calls">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="stat-content">
                        <h6>Total Calls</h6>
                        <p id="total-calls">0</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon meetings">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="stat-content">
                        <h6>Total Meetings</h6>
                        <p id="total-meetings">0</p>
                    </div>
                </div>
            </div>

            <!-- Today's Reminders -->
            <div class="reminders-section mt-4">
                <h5 class="mb-3 d-flex align-items-center">
                    <i class="fas fa-bell text-warning me-2"></i> Today's Reminders
                    <span id="reminder-count" class="badge bg-danger ms-2 d-none">0</span>
                </h5>
                <div id="reminders-list">
                    <p class="text-muted">Checking for reminders...</p>
                </div>
            </div>

        </div>


    </div>
    </div>

    <!-- Request Quotation Modal -->
    <div class="modal fade" id="quotationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Quotation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Embedded Zoho Form -->
                    <iframe src="https://zfrmz.in/KYafI4HZrgOZRwy4zKaU"
                        style="width: 100%; min-height: 600px; border: none;" frameborder="0" allowfullscreen>
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/common.js"></script>
    <script>
        // Check authentication
        if (!initAuthCheck('user')) {
            window.location.href = '../index.html'
        }

        // Insert navigation
        insertNav('user', 'dashboard')

        // Get session
        const session = getCurrentSession()

        // Load dashboard data
        async function updateDashboard() {
            try {
                // Load attendance
                const today = new Date().toISOString().split('T')[0]
                const attendance = await getAttendance(session.userId, today)

                if (attendance && attendance.clock_in && !attendance.clock_out) {
                    document.getElementById('attendance-status').textContent = 'Clocked In'
                } else if (attendance && attendance.clock_out) {
                    document.getElementById('attendance-status').textContent = 'Clocked Out'
                } else {
                    document.getElementById('attendance-status').textContent = 'Not Clocked In'
                }

                // Load leads count
                const leads = await getLeads(session.userId)
                document.getElementById('total-leads').textContent = leads.length

                // Load calls count
                const calls = await getCalls(session.userId)
                document.getElementById('total-calls').textContent = calls.length

                // Load meetings count
                const meetings = await getMeetings(session.userId)
                document.getElementById('total-meetings').textContent = meetings.length


                // Load reminders
                displayReminders(leads)

            } catch (error) {
                console.error('Error loading dashboard:', error)
            }
        }


        function displayReminders(leads) {
            const reminderContainer = document.getElementById('reminders-list')
            const reminderCountBadge = document.getElementById('reminder-count')

            const today = new Date().toISOString().split('T')[0]

            const reminders = leads.filter(lead => {
                if (!lead.follow_up_date) return false
                return lead.follow_up_date <= today && lead.status !== 'Qualified' && lead.status !== 'Closed' && lead.status !== 'Not Converted'
            }).sort((a, b) => new Date(a.follow_up_date) - new Date(b.follow_up_date))

            if (reminders.length === 0) {
                reminderContainer.innerHTML = `
                    <div class="text-center py-5">
                        <div class="mb-3 text-muted" style="font-size: 3rem;">
                            <i class="fas fa-check-circle text-success opacity-25"></i>
                        </div>
                        <h6 class="text-muted">All caught up!</h6>
                        <p class="text-muted small">No urgent follow-ups for today.</p>
                    </div>
                `
                reminderCountBadge.classList.add('d-none')
                return
            }

            reminderCountBadge.textContent = reminders.length
            reminderCountBadge.classList.remove('d-none')

            reminderContainer.innerHTML = `
                <div class="reminders-grid">
                    ${reminders.map(lead => {
                const isOverdue = lead.follow_up_date < today
                return `
                            <div class="premium-reminder-card" onclick="window.location.href='leads.html?id=${lead.id}'">
                                <span class="reminder-badge ${isOverdue ? 'overdue' : 'today'}">
                                    ${isOverdue ? 'Overdue' : 'Due Today'}
                                </span>
                                <div class="reminder-icon-box ${isOverdue ? 'overdue' : 'due-today'}">
                                    <i class="fas ${isOverdue ? 'fa-exclamation-triangle' : 'fa-calendar-day'}"></i>
                                </div>
                                <div class="reminder-info">
                                    <h6>${lead.name}</h6>
                                    <span>${isOverdue ? 'Was due on' : 'Scheduled for'} ${new Date(lead.follow_up_date).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                </div>
                                <div class="reminder-action-btn">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        `
            }).join('')}
                </div>
            `
        }


        // Initialize dashboard
        updateDashboard()
    </script>
</body>

</html>