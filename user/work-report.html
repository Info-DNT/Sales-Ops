<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Report - Sales Ops</title>
    <link rel="icon" href="../assets/logo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .report-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .report-card {
            background: white;
            border-radius: 12px;
            padding: 2.5rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            border: 2px solid transparent;
        }

        .report-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }

        .report-card-icon {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: white;
        }

        .report-card-icon.calls {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .report-card-icon.meetings {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .report-card-icon.leads {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .report-card-icon.expenses {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .report-card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .report-card-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 0;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Sidebar will be inserted here -->

        <div class="main-content">
            <div class="page-header">
                <h2>Work Report</h2>
                <p class="text-muted mb-0"></p>
            </div>

            <div class="report-cards-grid">
                <!-- Calls Card -->
                <div class="report-card" data-bs-toggle="modal" data-bs-target="#callModal">
                    <div class="report-card-icon calls">
                        <i class="fas fa-phone"></i>
                    </div>
                    <h3 class="report-card-title">Calls</h3>
                    <p class="report-card-description">Record and manage your call activities</p>
                </div>

                <!-- Meetings Card -->
                <div class="report-card" data-bs-toggle="modal" data-bs-target="#meetingModal">
                    <div class="report-card-icon meetings">
                        <i class="fas fa-video"></i>
                    </div>
                    <h3 class="report-card-title">Meetings</h3>
                    <p class="report-card-description">Track your meetings and outcomes</p>
                </div>

                <!-- Leads Card -->
                <div class="report-card" data-bs-toggle="modal" data-bs-target="#leadModal">
                    <div class="report-card-icon leads">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <h3 class="report-card-title">Leads</h3>
                    <p class="report-card-description">Manage your leads and opportunities</p>
                </div>

                <!-- Expenses Card -->
                <div class="report-card" data-bs-toggle="modal" data-bs-target="#expenseModal">
                    <div class="report-card-icon expenses">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h3 class="report-card-title">Expenses</h3>
                    <p class="report-card-description">Submit and track your work expenses</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Modal -->
    <div class="modal fade" id="callModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Call</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="call-form">
                        <div class="mb-3">
                            <label for="call-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="call-name" placeholder="Enter name" required>
                        </div>
                        <div class="mb-3">
                            <label for="call-phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="call-phone" placeholder="Enter phone number"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="call-designation" class="form-label">Designation</label>
                            <input type="text" class="form-control" id="call-designation"
                                placeholder="Enter designation" required>
                        </div>
                        <div class="mb-3">
                            <label for="call-hospital" class="form-label">Hospital Name</label>
                            <input type="text" class="form-control" id="call-hospital" placeholder="Enter hospital name"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="call-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="call-date" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="save-call-btn">
                            <i class="fas fa-save"></i> Save Call
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Meeting Modal -->
    <div class="modal fade" id="meetingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Meeting</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="meeting-form">
                        <div class="mb-3">
                            <label for="meeting-with" class="form-label">Meeting with whom</label>
                            <input type="text" class="form-control" id="meeting-with" placeholder="Enter person's name"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="meeting-client" class="form-label">Name of the client</label>
                            <input type="text" class="form-control" id="meeting-client" placeholder="Enter client name"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="meeting-agenda" class="form-label">Agenda</label>
                            <textarea class="form-control" id="meeting-agenda" rows="3"
                                placeholder="Enter meeting agenda" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="meeting-outcome" class="form-label">Outcome</label>
                            <textarea class="form-control" id="meeting-outcome" rows="3"
                                placeholder="Enter meeting outcome"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="meeting-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="meeting-date" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="save-meeting-btn">
                            <i class="fas fa-save"></i> Save Meeting
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Modal -->
    <div class="modal fade" id="leadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Lead</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="lead-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-name" class="form-label">Client Name</label>
                                <input type="text" class="form-control" id="lead-name" placeholder="Enter client name"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lead-contact" class="form-label">Client Phone</label>
                                <input type="tel" class="form-control" id="lead-contact"
                                    placeholder="Enter client phone" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-email" class="form-label">Client Email</label>
                                <input type="email" class="form-control" id="lead-email"
                                    placeholder="Enter client email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lead-owner" class="form-label">Lead Owner</label>
                                <input type="text" class="form-control" id="lead-owner" readonly>
                            </div>
                        </div>

                        <hr class="my-3">
                        <h6 class="mb-3">Patient Information</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patient-name" class="form-label">Patient Name</label>
                                <input type="text" class="form-control" id="patient-name"
                                    placeholder="Enter patient name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patient-contact" class="form-label">Patient Contact</label>
                                <input type="tel" class="form-control" id="patient-contact"
                                    placeholder="Enter patient contact">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="patient-email" class="form-label">Patient Email</label>
                                <input type="email" class="form-control" id="patient-email"
                                    placeholder="Enter patient email">
                            </div>
                        </div>

                        <hr class="my-3">
                        <h6 class="mb-3">Travel Details</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="source-location" class="form-label">Source Location</label>
                                <input type="text" class="form-control" id="source-location"
                                    placeholder="Enter source location">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="destination-location" class="form-label">Destination Location</label>
                                <input type="text" class="form-control" id="destination-location"
                                    placeholder="Enter destination location">
                            </div>
                        </div>

                        <hr class="my-3">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-source" class="form-label">Lead Source</label>
                                <select class="form-control" id="lead-source">
                                    <option value="">Select Source</option>
                                    <option value="WhatsApp">WhatsApp</option>
                                    <option value="Hospital">Hospital</option>
                                    <option value="Reference">Reference</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Consulates">Consulates</option>
                                    <option value="Embassy">Embassy</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lead-field" class="form-label">Field</label>
                                <select class="form-control" id="lead-field">
                                    <option value="">Select Field</option>
                                    <option value="Medical Tourism">Medical Tourism</option>
                                    <option value="Medical Evacuation">Medical Evacuation</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-status" class="form-label">Status</label>
                                <select class="form-select" id="lead-status">
                                    <option value="">Select status</option>
                                    <option value="New">New</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Closed">Closed</option>
                                    <option value="Not Converted">Not Converted</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="follow-up-date" class="form-label">Follow-up Date</label>
                                <input type="date" class="form-control" id="follow-up-date" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="expected-close" class="form-label">Expected Close</label>
                                <input type="date" class="form-control" id="expected-close">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="next-action" class="form-label">Next Action</label>
                            <textarea class="form-control" id="next-action" rows="2" placeholder="Enter next action"
                                required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="lead-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="lead-date" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="save-lead-btn">
                            <i class="fas fa-save"></i> Save Lead
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-receipt me-2 text-warning"></i>Add Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="expense-form">
                        <div class="mb-3">
                            <label for="wr-exp-category" class="form-label">Category</label>
                            <select class="form-select" id="wr-exp-category" required>
                                <option value="">Select category</option>
                                <option value="Travel">Travel</option>
                                <option value="Food &amp; Meals">Food &amp; Meals</option>
                                <option value="Accommodation">Accommodation</option>
                                <option value="Client Entertainment">Client Entertainment</option>
                                <option value="Office Supplies">Office Supplies</option>
                                <option value="Communication">Communication</option>
                                <option value="Medical">Medical</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="wr-exp-amount" class="form-label">Amount (AED)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="wr-exp-amount"
                                placeholder="0.00" required>
                        </div>
                        <div class="mb-3">
                            <label for="wr-exp-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="wr-exp-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="wr-exp-desc" class="form-label">Description</label>
                            <textarea class="form-control" id="wr-exp-desc" rows="3"
                                placeholder="Describe this expense..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="save-expense-btn">
                            <i class="fas fa-save"></i> Save Expense
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/auto-date.js"></script>
    <script>
        // Check authentication
        if (!initAuthCheck('user')) {
            window.location.href = '../index.html'
        }

        // Insert navigation
        insertNav('user', 'work-report')

        // Get session
        const session = getCurrentSession()

        // Auto-fill lead owner for new leads
        if (session) {
            const ownerInput = document.getElementById('lead-owner');
            if (ownerInput) {
                ownerInput.value = session.name || session.email || '';
            }
        }

        // Handle Call Form Submission
        document.getElementById('call-form').addEventListener('submit', async function (e) {
            e.preventDefault()

            const saveBtn = document.getElementById('save-call-btn')
            const spinner = saveBtn.querySelector('.spinner-border')

            saveBtn.disabled = true
            spinner.classList.remove('d-none')

            try {
                const callData = {
                    name: document.getElementById('call-name').value,
                    phone: document.getElementById('call-phone').value,
                    designation: document.getElementById('call-designation').value,
                    hospitalName: document.getElementById('call-hospital').value,
                    callDate: document.getElementById('call-date').value
                }

                await createCall(session.userId, callData)
                showToast('Call added successfully!', 'success')

                // Reset form and close modal
                this.reset()
                bootstrap.Modal.getInstance(document.getElementById('callModal')).hide()
            } catch (error) {
                console.error('Error saving call:', error)
                showToast('Failed to save call', 'error')
            } finally {
                saveBtn.disabled = false
                spinner.classList.add('d-none')
            }
        })

        // Handle Meeting Form Submission
        document.getElementById('meeting-form').addEventListener('submit', async function (e) {
            e.preventDefault()

            const saveBtn = document.getElementById('save-meeting-btn')
            const spinner = saveBtn.querySelector('.spinner-border')

            saveBtn.disabled = true
            spinner.classList.remove('d-none')

            try {
                const meetingData = {
                    meetingWith: document.getElementById('meeting-with').value,
                    clientName: document.getElementById('meeting-client').value,
                    agenda: document.getElementById('meeting-agenda').value,
                    outcome: document.getElementById('meeting-outcome').value,
                    meetingDate: document.getElementById('meeting-date').value
                }

                await createMeeting(session.userId, meetingData)
                showToast('Meeting added successfully!', 'success')

                // Reset form and close modal
                this.reset()
                bootstrap.Modal.getInstance(document.getElementById('meetingModal')).hide()
            } catch (error) {
                console.error('Error saving meeting:', error)
                showToast('Failed to save meeting', 'error')
            } finally {
                saveBtn.disabled = false
                spinner.classList.add('d-none')
            }
        })

        // Handle Lead Form Submission
        document.getElementById('lead-form').addEventListener('submit', async function (e) {
            e.preventDefault()

            const saveBtn = document.getElementById('save-lead-btn')
            const spinner = saveBtn.querySelector('.spinner-border')

            saveBtn.disabled = true
            spinner.classList.remove('d-none')

            try {
                const leadData = {
                    name: document.getElementById('lead-name').value,
                    contact: document.getElementById('lead-contact').value,
                    email: document.getElementById('lead-email').value,
                    patientName: document.getElementById('patient-name').value,
                    patientContact: document.getElementById('patient-contact').value,
                    patientEmail: document.getElementById('patient-email').value,
                    sourceLocation: document.getElementById('source-location').value,
                    destinationLocation: document.getElementById('destination-location').value,
                    owner: document.getElementById('lead-owner').value,
                    status: document.getElementById('lead-status').value,
                    leadSource: document.getElementById('lead-source').value,
                    leadField: document.getElementById('lead-field').value,
                    followUpDate: document.getElementById('follow-up-date').value,
                    nextAction: document.getElementById('next-action').value,
                    expectedClose: document.getElementById('expected-close').value
                }

                await createLead(session.userId, leadData)
                showToast('Lead added successfully!', 'success')

                // Reset form and close modal
                this.reset()
                bootstrap.Modal.getInstance(document.getElementById('leadModal')).hide()
            } catch (error) {
                console.error('Error saving lead:', error)
                showToast('Failed to save lead', 'error')
            } finally {
                saveBtn.disabled = false
                spinner.classList.add('d-none')
            }
        })

        // Handle Expense Form Submission
        document.addEventListener('DOMContentLoaded', function () {
            // Set today as default date for expense
            const expDateInput = document.getElementById('wr-exp-date');
            if (expDateInput) expDateInput.valueAsDate = new Date();
        });

        document.getElementById('expense-form').addEventListener('submit', async function (e) {
            e.preventDefault()

            const saveBtn = document.getElementById('save-expense-btn')
            const spinner = saveBtn.querySelector('.spinner-border')

            saveBtn.disabled = true
            spinner.classList.remove('d-none')

            try {
                const expenseData = {
                    category: document.getElementById('wr-exp-category').value,
                    amount: document.getElementById('wr-exp-amount').value,
                    date: document.getElementById('wr-exp-date').value,
                    description: document.getElementById('wr-exp-desc').value,
                    receiptUrl: null
                }

                await createExpense(session.userId, expenseData)
                showToast('Expense submitted successfully!', 'success')

                // Reset form and close modal
                this.reset()
                document.getElementById('wr-exp-date').valueAsDate = new Date();
                bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide()
            } catch (error) {
                console.error('Error saving expense:', error)
                showToast('Failed to save expense', 'error')
            } finally {
                saveBtn.disabled = false
                spinner.classList.add('d-none')
            }
        })
    </script>
</body>

</html>