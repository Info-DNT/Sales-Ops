<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads - Sales Ops</title>
    <link rel="icon" href="../assets/logo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/crm-styles.css">
</head>

<body>
    <div id="app">
        <!-- Sidebar will be inserted here -->

        <div class="main-content">
            <div class="page-header flex-wrap gap-3">
                <h2 class="mb-0">Leads</h2>
                <div class="d-flex flex-wrap gap-2 w-100-mobile align-items-center">
                    <div class="d-none d-lg-flex gap-2">
                        <input type="date" class="form-control" id="header-search-date" style="width: 150px;"
                            onchange="syncAndSearch('date', this.value)">
                        <input type="tel" class="form-control" id="header-search-contact" style="width: 150px;"
                            placeholder="Contact" oninput="syncAndSearch('contact', this.value)">
                    </div>

                    <button class="btn btn-primary w-100-mobile" data-bs-toggle="modal" data-bs-target="#addLeadModal">
                        <i class="fas fa-plus"></i> Add Lead
                    </button>
                </div>
            </div>

            <!-- Urgent Tasks Panel -->
            <div id="urgent-tasks-container" style="display: none;">
                <div class="alert-panel">
                    <div class="alert-panel-header">
                        <div class="alert-panel-title">
                            <i class="fas fa-bell"></i> Urgent Follow-ups Due Today
                        </div>
                    </div>
                    <div id="urgent-leads-list" class="row g-3">
                        <!-- Urgent leads will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Search/Filter -->
            <div class="content-card mb-3">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Search Date</label>
                        <input type="date" class="form-control" id="search-date">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Search Client Phone</label>
                        <input type="tel" class="form-control" id="search-contact" placeholder="Client Phone number">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Filter Status</label>
                        <select class="form-select" id="filter-status">
                            <option value="">All Statuses</option>
                            <option value="New">New</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Qualified">Qualified</option>
                            <option value="Closed">Closed</option>
                            <option value="Not Converted">Not Converted</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6 d-flex align-items-end gap-2">
                        <button class="btn btn-secondary flex-grow-1" onclick="applyCombinedFilters()">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearAllFilters()">
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <h5 class="mb-3">Lead Details</h5>
                <div id="leads-list" class="leads-container">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal fade" id="addLeadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Lead</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-lead-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-name" class="form-label">Client Name</label>
                                <input type="text" class="form-control" id="lead-name" placeholder="Enter client name"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lead-contact" class="form-label">Client Phone</label>
                                <input type="tel" class="form-control" id="lead-contact"
                                    placeholder="Enter client phone" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-email" class="form-label">Client Email</label>
                                <input type="email" class="form-control" id="lead-email"
                                    placeholder="Enter client email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lead-owner" class="form-label">Lead Owner</label>
                                <input type="text" class="form-control" id="lead-owner" readonly>
                            </div>
                        </div>

                        <hr class="my-3">
                        <h6 class="mb-3">Patient Information</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patient-name" class="form-label">Patient Name</label>
                                <input type="text" class="form-control" id="patient-name"
                                    placeholder="Enter patient name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="client-relation" class="form-label">Client Relation</label>
                                <input type="text" class="form-control" id="client-relation"
                                    placeholder="Enter relation with client">
                            </div>
                        </div>

                        <hr class="my-3">
                        <h6 class="mb-3">Travel Details</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="source-location" class="form-label">Source Location</label>
                                <input type="text" class="form-control" id="source-location"
                                    placeholder="Enter source location">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="destination-location" class="form-label">Destination Location</label>
                                <input type="text" class="form-control" id="destination-location"
                                    placeholder="Enter destination location">
                            </div>
                        </div>

                        <hr class="my-3">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-status" class="form-label">Lead Status</label>
                                <select class="form-control" id="lead-status" required>
                                    <option value="New">New</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Closed">Closed</option>
                                    <option value="Not Converted">Not Converted</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lead-source" class="form-label">Lead Source</label>
                                <select class="form-control" id="lead-source">
                                    <option value="">Select Source</option>
                                    <option value="WhatsApp">WhatsApp</option>
                                    <option value="Hospital">Hospital</option>
                                    <option value="Reference">Reference</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Consulates">Consulates</option>
                                    <option value="Embassy">Embassy</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="lead-field" class="form-label">Category</label>
                                <select class="form-control" id="lead-field">
                                    <option value="">Select Field</option>
                                    <option value="Medical Tourism">Medical Tourism</option>
                                    <option value="Medical Evacuation">Medical Evacuation</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="follow-up-date" class="form-label">Follow-up Date</label>
                            <input type="date" class="form-control" id="follow-up-date" required>
                        </div>

                        <div class="mb-3">
                            <label for="next-action" class="form-label">Next Action</label>
                            <textarea class="form-control" id="next-action" rows="2"
                                placeholder="Describe next action"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="expected-close" class="form-label">Expected Close Date</label>
                            <input type="date" class="form-control" id="expected-close">
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="add-lead-btn">
                            <i class="fas fa-check"></i> Save Lead
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Details Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="leadDetailsOffcanvas" style="width: 500px;">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title" id="details-lead-name">Lead Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <!-- Tabs -->
            <ul class="nav nav-tabs-custom px-4" id="detailsTabs">
                <li><a href="#" class="nav-link active" onclick="switchDetailsTab('overview')">Overview</a></li>
                <li><a href="#" class="nav-link" onclick="switchDetailsTab('timeline')">Timeline</a></li>
            </ul>

            <!-- Content Area -->
            <div class="px-4 pb-4">
                <!-- Overview Tab -->
                <div id="tab-overview" class="details-tab-content">
                    <form id="edit-lead-form">
                        <input type="hidden" id="edit-lead-id">
                        <div class="mb-3">
                            <label class="form-label">Client Name</label>
                            <input type="text" class="form-control" id="edit-lead-name" placeholder="Client Name"
                                required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Client Phone</label>
                                <input type="tel" class="form-control" id="edit-lead-contact" placeholder="Client Phone"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Client Email</label>
                                <input type="email" class="form-control" id="edit-lead-email"
                                    placeholder="Client Email">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Patient Name</label>
                                <input type="text" class="form-control" id="edit-patient-name"
                                    placeholder="Patient Name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Client Relation</label>
                                <input type="text" class="form-control" id="edit-client-relation"
                                    placeholder="Relation with client">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Source Location</label>
                                <input type="text" class="form-control" id="edit-source-location"
                                    placeholder="Source Location">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Destination Location</label>
                                <input type="text" class="form-control" id="edit-destination-location"
                                    placeholder="Destination Location">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-control" id="edit-lead-status">
                                    <option value="New">New</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Closed">Closed</option>
                                    <option value="Not Converted">Not Converted</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Owner</label>
                                <input type="text" class="form-control" id="edit-lead-owner" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Next Action</label>
                            <textarea class="form-control" id="edit-lead-next-action" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Follow-up Date</label>
                                <input type="date" class="form-control" id="edit-lead-follow-up">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Expected Close</label>
                                <input type="date" class="form-control" id="edit-lead-expected-close">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-2" id="save-lead-btn">
                            Save Changes
                        </button>
                    </form>
                </div>

                <!-- Timeline Tab -->
                <div id="tab-timeline" class="details-tab-content d-none">
                    <div id="timeline-container" class="timeline">
                        <!-- Activity items will be inserted here -->
                        <p class="text-muted text-center py-4">Loading history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Request Quotation Modal -->
    <div class="modal fade" id="quotationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Quotation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <iframe
                        src="https://forms.zohopublic.in/digitalnexttechnolgy1/form/StartingForm/formperma/Z6YQKREPtFOzQUrq0sEHVUvmy2zQrhu8odzhV3g-PLA"
                        style="width: 100%; min-height: 600px; border: none;" frameborder="0" allowfullscreen>
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/zoho-integration.js"></script>
    <script>
        // Check authentication
        if (!initAuthCheck('user')) {
            window.location.href = '../index.html'
        }

        // Insert navigation
        insertNav('user', 'leads')

        // Get session
        const session = getCurrentSession()
        let leads = []
        let allLeads = []
        let editingLeadId = null

        // Auto-fill lead owner for new leads
        if (session) {
            const ownerInput = document.getElementById('lead-owner');
            if (ownerInput) {
                ownerInput.value = session.name || session.email || '';
            }
        }

        // Load leads
        async function loadLeads() {
            try {
                allLeads = await getLeads(session.userId)
                leads = allLeads
                displayLeads()
            } catch (error) {
                console.error('Error loading leads:', error)
                showToast('Failed to load leads', 'error')
            }
        }

        // Search by date and/or contact number
        // Search handlers relocated

        // Combined filter function for mobile
        function applyCombinedFilters() {
            const searchDate = document.getElementById('search-date').value
            const searchContact = document.getElementById('search-contact').value
            const filterStatus = document.getElementById('filter-status').value

            let filtered = allLeads

            if (searchDate) {
                filtered = filtered.filter(lead => {
                    const createdDate = lead.created_at.split('T')[0]
                    return createdDate === searchDate || (lead.follow_up_date && lead.follow_up_date === searchDate)
                })
            }

            if (searchContact) {
                filtered = filtered.filter(lead => lead.contact.includes(searchContact))
            }

            if (filterStatus) {
                filtered = filtered.filter(lead => lead.status === filterStatus)
            }

            leads = filtered
            displayLeads()

            if (leads.length === 0) {
                showToast('No leads found matching your criteria', 'info')
            }
        }

        // Sync header and main search inputs
        function syncAndSearch(type, value) {
            if (type === 'date') {
                const el = document.getElementById('search-date');
                if (el) el.value = value;
            } else if (type === 'contact') {
                const el = document.getElementById('search-contact');
                if (el) el.value = value;
            }
            applyCombinedFilters();
        }

        function clearAllFilters() {
            document.getElementById('search-date').value = ''
            document.getElementById('search-contact').value = ''
            document.getElementById('filter-status').value = ''
            leads = allLeads
            displayLeads()
        }

        // Backward compatibility
        function searchLeads() { applyCombinedFilters(); }
        function applyFilters() { applyCombinedFilters(); }
        function clearSearch() { clearAllFilters(); }
        function clearFilters() { clearAllFilters(); }

        // Display leads
        function displayLeads() {
            const leadsContainer = document.getElementById('leads-list')

            if (!leads || leads.length === 0) {
                leadsContainer.innerHTML = '<p class="text-muted text-center py-4">No leads found.</p>'
                return
            }

            leadsContainer.innerHTML = leads
                .map(lead => {
                    const isCRM = lead.lead_source && lead.lead_source !== '';

                    // 1. Calculate Stale Status (Aging)
                    const lastUpdate = new Date(lead.updated_at || lead.created_at);
                    const diffDays = Math.floor((new Date() - lastUpdate) / (1000 * 60 * 60 * 24));
                    let agingClass = '';
                    if (diffDays >= 7) agingClass = 'stale-pulse-danger';
                    else if (diffDays >= 3) agingClass = 'stale-pulse-warning';

                    // 2. Calculate Follow-up Status (Urgent)
                    const today = new Date().toISOString().split('T')[0];
                    const isUrgent = lead.follow_up_date && lead.follow_up_date <= today && lead.status !== 'Closed';

                    return `
                    <div class="lead-card mb-3 ${isCRM ? 'crm-lead' : ''} ${agingClass}" onclick="openLeadDetails('${lead.id}')" style="cursor: pointer;">
                        <div class="lead-header">
                            <div class="lead-title">
                                <h6>
                                    ${lead.name}
                                    ${isCRM ? '<span class="crm-badge">CRM</span>' : ''}
                                    ${isUrgent ? '<span class="urgent-badge"><i class="fas fa-exclamation-circle"></i> Follow-up Due</span>' : ''}
                                </h6>
                            </div>
                            <span class="lead-status-badge ${lead.status.toLowerCase().replace(' ', '-')}">${lead.status}</span>
                        </div>

                        <div class="lead-details">
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Client Phone</span>
                                <span class="lead-detail-value">${lead.contact}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Client Email</span>
                                <span class="lead-detail-value">${lead.email}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Patient Name</span>
                                <span class="lead-detail-value">${lead.patient_name || '--'}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Lead Owner</span>
                                <span class="lead-detail-value">${lead.owner || 'Not assigned'}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Aging Status</span>
                                <span class="lead-detail-value ${diffDays >= 3 ? 'text-warning fw-bold' : ''}">${diffDays === 0 ? 'Active Today' : diffDays + ' days inactive'}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Follow-up Date</span>
                                <span class="lead-detail-value ${isUrgent ? 'text-danger fw-bold' : ''}">${lead.follow_up_date || 'Not set'}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Expected Close</span>
                                <span class="lead-detail-value">${lead.expected_close || 'Not specified'}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Source Location</span>
                                <span class="lead-detail-value">${lead.source_location || '--'}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Destination</span>
                                <span class="lead-detail-value">${lead.destination_location || '--'}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Created</span>
                                <span class="lead-detail-value">${new Date(lead.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>

                        <div class="mt-3 p-2 bg-light rounded">
                            <p class="mb-0 text-muted small"><strong>Next Action:</strong> ${lead.next_action || 'No action specified'}</p>
                        </div>

                        <!-- Lead Actions -->
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quotationModal" onclick="event.stopPropagation()">
                                <i class="fas fa-file-invoice-dollar"></i> Request Quotation
                            </button>
                        </div>
                    </div>
                    `;
                })
                .join('')

            if (typeof displayUrgentPanel === 'function') {
                displayUrgentPanel(leads);
            }
        }

        function displayUrgentPanel(leads) {
            const urgentContainer = document.getElementById('urgent-tasks-container');
            const urgentList = document.getElementById('urgent-leads-list');
            if (!urgentContainer || !urgentList) return;

            const today = new Date().toISOString().split('T')[0];
            const urgentLeads = leads.filter(l => l.follow_up_date && l.follow_up_date <= today && l.status !== 'Closed');

            if (urgentLeads.length === 0) {
                urgentContainer.style.display = 'none';
                return;
            }

            urgentContainer.style.display = 'block';
            urgentList.innerHTML = urgentLeads.map(lead => `
                <div class="col-md-4">
                    <div class="card border-danger h-100 shadow-sm" onclick="openLeadDetails('${lead.id}')" style="cursor: pointer; border-left: 5px solid #ef4444 !important;">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-1">${lead.name}</h6>
                            <p class="card-text small text-muted mb-2">
                                <i class="fas fa-phone me-1"></i> ${lead.contact}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-danger">DUE TODAY</span>
                                <small class="text-muted"><i class="fas fa-history"></i> ${lead.follow_up_date}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Request Notification Permission and Send
            if (window.Notification && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        const urgentCount = urgentLeads.length;
                        new Notification('Urgent Sales Tasks', {
                            body: `You have ${urgentCount} follow-ups due today!`,
                        });
                    }
                });
            }
        }


        // Apply filters
        function applyFilters() {
            applyCombinedFilters();
        }

        // Clear filters
        function clearFilters() {
            clearAllFilters();
        }

        // Handle add lead form submission
        document.getElementById('add-lead-form').addEventListener('submit', async function (e) {
            e.preventDefault()

            const addBtn = document.getElementById('add-lead-btn')
            const spinner = addBtn.querySelector('.spinner-border')

            addBtn.disabled = true
            spinner.classList.remove('d-none')

            try {
                const lead = {
                    name: document.getElementById('lead-name').value,
                    contact: document.getElementById('lead-contact').value,
                    email: document.getElementById('lead-email').value,
                    patientName: document.getElementById('patient-name').value,
                    clientRelation: document.getElementById('client-relation').value,
                    sourceLocation: document.getElementById('source-location').value,
                    destinationLocation: document.getElementById('destination-location').value,
                    owner: document.getElementById('lead-owner').value,
                    status: document.getElementById('lead-status').value,
                    leadSource: document.getElementById('lead-source').value,
                    leadField: document.getElementById('lead-field').value,
                    followUpDate: document.getElementById('follow-up-date').value,
                    nextAction: document.getElementById('next-action').value,
                    expectedClose: document.getElementById('expected-close').value
                }

                const newLead = await createLead(session.userId, lead)
                leads.unshift(newLead)
                displayLeads()

                // Reset form and close modal
                this.reset()
                bootstrap.Modal.getInstance(document.getElementById('addLeadModal')).hide()

                showToast('Lead added successfully!', 'success')
            } catch (error) {
                console.error('Error adding lead:', error)
                showToast('Failed to add lead', 'error')
            } finally {
                addBtn.disabled = false
                spinner.classList.add('d-none')
            }
        })

        // Lead Details Functions
        async function openLeadDetails(leadId) {
            editingLeadId = leadId;
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) return;

            // Fill overview form
            document.getElementById('details-lead-name').textContent = lead.name;
            document.getElementById('edit-lead-id').value = lead.id;
            document.getElementById('edit-lead-name').value = lead.name;
            document.getElementById('edit-lead-contact').value = lead.contact;
            document.getElementById('edit-lead-email').value = lead.email || '';
            document.getElementById('edit-lead-status').value = lead.status;
            document.getElementById('edit-lead-owner').value = lead.owner || '';
            document.getElementById('edit-patient-name').value = lead.patient_name || '';
            document.getElementById('edit-client-relation').value = lead.client_relation || '';
            document.getElementById('edit-source-location').value = lead.source_location || '';
            document.getElementById('edit-destination-location').value = lead.destination_location || '';
            document.getElementById('edit-lead-next-action').value = lead.next_action || '';
            document.getElementById('edit-lead-follow-up').value = lead.follow_up_date || '';
            document.getElementById('edit-lead-expected-close').value = lead.expected_close || '';

            // Switch to overview tab by default
            switchDetailsTab('overview');

            // Show offcanvas
            const offcanvasElement = document.getElementById('leadDetailsOffcanvas');
            const offcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement) || new bootstrap.Offcanvas(offcanvasElement);
            offcanvas.show();

            // Load history
            loadLeadHistory(leadId);
        }

        function switchDetailsTab(tab) {
            const overviewTab = document.getElementById('tab-overview');
            const timelineTab = document.getElementById('tab-timeline');
            const links = document.querySelectorAll('#detailsTabs .nav-link');

            if (tab === 'overview') {
                overviewTab.classList.remove('d-none');
                timelineTab.classList.add('d-none');
                links[0].classList.add('active');
                links[1].classList.remove('active');
            } else {
                overviewTab.classList.add('d-none');
                timelineTab.classList.remove('d-none');
                links[0].classList.remove('active');
                links[1].classList.add('active');
            }
        }

        async function loadLeadHistory(leadId) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '<p class="text-muted text-center py-4">Loading history...</p>';

            try {
                const history = await getLeadHistory(leadId);
                if (!history || history.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center py-4">No activity yet.</p>';
                    return;
                }

                container.innerHTML = history.map(item => `
                    <div class="timeline-item">
                        <div class="timeline-dot">
                            <i class="fas ${item.action.includes('Created') ? 'fa-plus' : 'fa-edit'}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-time">${new Date(item.created_at).toLocaleString()}</div>
                            <div class="timeline-title">${item.action}</div>
                            <div class="timeline-desc">${item.details.summary || item.details.status || (item.details.changes ? item.details.changes.join(', ') : '') || ''}</div>
                            <div class="small text-muted mt-1">by ${item.users?.name || item.users?.email || 'User'}</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading history:', error);
                container.innerHTML = '<p class="text-danger text-center py-4">Error loading history.</p>';
            }
        }

        document.getElementById('edit-lead-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const saveBtn = document.getElementById('save-lead-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Saving...';

            try {
                const updates = {
                    name: document.getElementById('edit-lead-name').value,
                    contact: document.getElementById('edit-lead-contact').value,
                    email: document.getElementById('edit-lead-email').value,
                    status: document.getElementById('edit-lead-status').value,
                    owner: document.getElementById('edit-lead-owner').value,
                    nextAction: document.getElementById('edit-lead-next-action').value,
                    followUpDate: document.getElementById('edit-lead-follow-up').value,
                    expectedClose: document.getElementById('edit-lead-expected-close').value,
                    patientName: document.getElementById('edit-patient-name').value,
                    clientRelation: document.getElementById('edit-client-relation').value,
                    sourceLocation: document.getElementById('edit-source-location').value,
                    destinationLocation: document.getElementById('edit-destination-location').value
                };

                await updateLead(editingLeadId, updates, session.userId);
                showToast('Lead updated successfully', 'success');

                // Refresh list
                await loadLeads();

                // Refresh history tab
                loadLeadHistory(editingLeadId);

            } catch (error) {
                console.error('Error updating lead:', error);
                showToast('Failed to update lead', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        })

        // Quotation Request Functions
        function openQuotationModal(leadId) {
            // Find the lead from the current leads array
            const lead = leads.find(l => l.id === leadId);

            if (!lead) {
                showToast('Lead not found', 'error');
                return;
            }

            // Pre-fill the form fields
            document.getElementById('quotation-lead-id').value = lead.id;
            document.getElementById('quotation-client-name').value = lead.name || '';
            document.getElementById('quotation-client-phone').value = lead.contact || '';
            document.getElementById('quotation-client-email').value = lead.email || '';
            document.getElementById('quotation-patient-name').value = lead.patient_name || '';

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('quotationModal'));
            modal.show();
        }

        async function submitQuotationRequest(event) {
            event.preventDefault();

            const leadId = document.getElementById('quotation-lead-id').value;
            const clientName = document.getElementById('quotation-client-name').value;
            const clientPhone = document.getElementById('quotation-client-phone').value;
            const clientEmail = document.getElementById('quotation-client-email').value;
            const patientName = document.getElementById('quotation-patient-name').value;

            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            try {
                // Create quotation in Supabase
                await createQuotation(session.userId, {
                    leadId: leadId,
                    clientName: clientName,
                    clientPhone: clientPhone,
                    clientEmail: clientEmail,
                    patientName: patientName
                });

                showToast('Quotation request submitted successfully!', 'success');

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('quotationModal'));
                modal.hide();

                // Reset form
                document.getElementById('quotationForm').reset();

            } catch (error) {
                console.error('Error submitting quotation:', error);
                showToast('Failed to submit quotation request', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Request';
            }
        }

        // Enable Real-time listener for leads
        function setupRealtimeLeads() {
            const client = initSupabase()
            if (!client || !session || !session.userId) return

            client
                .channel('user-leads-realtime')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'leads',
                    filter: `user_id=eq.${session.userId}`
                }, (payload) => {
                    // Refresh listing
                    loadLeads()

                    if (payload.eventType === 'INSERT') {
                        showToast('üöÄ New lead assigned to you!', 'success')
                        // Optional: Play a subtle notification sound
                    } else if (payload.eventType === 'UPDATE') {
                        // Check if it was newly assigned (from null or another user to current user)
                        // Note: payload.old is only available if replica identity is FULL
                        // But we can check if it's currently in our leads list or not
                        showToast('üìù Lead updated', 'info')
                    }
                })
                .subscribe()
        }

        // Initialize
        loadLeads()
        setupRealtimeLeads()
    </script>
</body>

</html>