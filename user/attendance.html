<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance - Sales Ops</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
    <div id="app">
        <!-- Sidebar will be inserted here -->

        <div class="main-content">
            <div class="page-header">
                <h2>Attendance Tracking</h2>
            </div>

            <div class="content-card">
                <div class="attendance-section">
                    <div class="clock-display">
                        <h4 id="current-time">00:00:00</h4>
                        <p id="current-date"></p>
                    </div>

                    <div class="clock-buttons">
                        <button id="clock-in-btn" class="btn btn-success btn-lg">
                            <i class="fas fa-sign-in-alt"></i> Clock In
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                        </button>
                        <button id="clock-out-btn" class="btn btn-danger btn-lg" disabled>
                            <i class="fas fa-sign-out-alt"></i> Clock Out
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                        </button>
                    </div>

                    <div class="status-info mt-4">
                        <p><strong>Status:</strong> <span id="attendance-time-status">Loading...</span></p>
                        <p><strong>Clock In Time:</strong> <span id="clock-in-time">--</span></p>
                        <p><strong>Clock Out Time:</strong> <span id="clock-out-time">--</span></p>
                        <p><strong>Hours Worked:</strong> <span id="hours-worked">0h 0m</span></p>
                    </div>
                </div>

                <hr>

                <h5 class="mt-4 mb-3">Attendance History</h5>
                <div id="attendance-history" class="history-list">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/common.js"></script>
    <script>
        // Check authentication
        if (!initAuthCheck('user')) {
            window.location.href = '../index.html'
        }

        // Insert navigation
        insertNav('user', 'attendance')

        // Get session
        const session = getCurrentSession()
        let todayAttendance = null
        let attendanceHistory = []

        // Update current time
        function updateCurrentTime() {
            const now = new Date()
            const hours = String(now.getHours()).padStart(2, '0')
            const minutes = String(now.getMinutes()).padStart(2, '0')
            const seconds = String(now.getSeconds()).padStart(2, '0')
            document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`
        }

        // Set current date
        const today = new Date()
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
        document.getElementById('current-date').textContent = today.toLocaleDateString('en-US', dateOptions)

        // Update time every second
        updateCurrentTime()
        setInterval(updateCurrentTime, 1000)

        // Load attendance data
        async function loadAttendance() {
            try {
                const todayDate = new Date().toISOString().split('T')[0]

                // Load today's attendance
                todayAttendance = await getAttendance(session.userId, todayDate)

                // Load history
                attendanceHistory = await getAllAttendance(session.userId)

                updateAttendanceUI()
                displayAttendanceHistory()
            } catch (error) {
                console.error('Error loading attendance:', error)
                document.getElementById('attendance-time-status').textContent = 'Not Started'
            }
        }

        // Update UI based on attendance status
        function updateAttendanceUI() {
            if (todayAttendance) {
                document.getElementById('clock-in-time').textContent = todayAttendance.clock_in || '--'

                if (todayAttendance.clock_in && !todayAttendance.clock_out) {
                    document.getElementById('clock-in-btn').disabled = true
                    document.getElementById('clock-out-btn').disabled = false
                    document.getElementById('attendance-time-status').textContent = 'Currently Working'
                } else if (todayAttendance.clock_out) {
                    document.getElementById('clock-in-btn').disabled = false
                    document.getElementById('clock-out-btn').disabled = true
                    document.getElementById('clock-out-time').textContent = todayAttendance.clock_out
                    const hours = Math.floor(todayAttendance.hours_worked || 0)
                    const minutes = Math.round(((todayAttendance.hours_worked || 0) % 1) * 60)
                    document.getElementById('hours-worked').textContent = `${hours}h ${minutes}m`
                    document.getElementById('attendance-time-status').textContent = 'Shift Completed'
                }
            } else {
                document.getElementById('attendance-time-status').textContent = 'Not Started'
                document.getElementById('clock-in-btn').disabled = false
                document.getElementById('clock-out-btn').disabled = true
            }
        }

        // Clock In
        document.getElementById('clock-in-btn').addEventListener('click', async function () {
            const btn = this
            const spinner = btn.querySelector('.spinner-border')

            btn.disabled = true
            spinner.classList.remove('d-none')

            try {
                todayAttendance = await clockIn(session.userId)

                document.getElementById('clock-out-btn').disabled = false
                document.getElementById('clock-in-time').textContent = todayAttendance.clock_in
                document.getElementById('attendance-time-status').textContent = 'Currently Working'

                showToast('Clocked in successfully!', 'success')
            } catch (error) {
                console.error('Error clocking in:', error)
                showToast('Failed to clock in', 'error')
                btn.disabled = false
            } finally {
                spinner.classList.add('d-none')
            }
        })

        // Clock Out
        document.getElementById('clock-out-btn').addEventListener('click', async function () {
            const btn = this
            const spinner = btn.querySelector('.spinner-border')

            btn.disabled = true
            spinner.classList.remove('d-none')

            try {
                todayAttendance = await clockOut(session.userId)

                document.getElementById('clock-in-btn').disabled = false
                document.getElementById('clock-out-time').textContent = todayAttendance.clock_out

                const hours = Math.floor(todayAttendance.hours_worked || 0)
                const minutes = Math.round(((todayAttendance.hours_worked || 0) % 1) * 60)
                document.getElementById('hours-worked').textContent = `${hours}h ${minutes}m`
                document.getElementById('attendance-time-status').textContent = 'Shift Completed'

                // Reload history
                attendanceHistory = await getAllAttendance(session.userId)
                displayAttendanceHistory()

                showToast(`Shift completed! Hours worked: ${hours}h ${minutes}m`, 'success')
            } catch (error) {
                console.error('Error clocking out:', error)
                showToast('Failed to clock out', 'error')
                btn.disabled = false
            } finally {
                spinner.classList.add('d-none')
            }
        })

        // Display Attendance History
        function displayAttendanceHistory() {
            const historyContainer = document.getElementById('attendance-history')

            if (!attendanceHistory || attendanceHistory.length === 0) {
                historyContainer.innerHTML = '<p class="text-muted">No records yet.</p>'
                return
            }

            historyContainer.innerHTML = attendanceHistory
                .map(record => {
                    const hours = Math.floor(record.hours_worked || 0)
                    const minutes = Math.round(((record.hours_worked || 0) % 1) * 60)
                    return `
                    <div class="history-item">
                        <div class="history-item-header">
                            <span class="history-item-date">${new Date(record.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
                            <span class="history-item-duration">${hours}h ${minutes}m</span>
                        </div>
                        <div class="history-times">
                            <span><strong>In:</strong> ${record.clock_in || '--'}</span>
                            <span><strong>Out:</strong> ${record.clock_out || 'Pending'}</span>
                        </div>
                    </div>
                `})
                .join('')
        }

        // Initialize
        loadAttendance()
    </script>
</body>

</html>