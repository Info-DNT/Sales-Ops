<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meetings - Admin - Sales Ops</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
    <div id="app">
        <!-- Sidebar will be inserted here -->

        <div class="main-content">
            <div class="page-header">
                <h2>All Meetings</h2>
                <div class="d-flex gap-2">
                    <input type="date" class="form-control" id="search-date" style="width: 200px;">
                    <button class="btn btn-secondary" onclick="searchByDate()">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>

            <div class="content-card">
                <div id="meetings-list" class="leads-container">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/common.js"></script>
    <script>
        // Check authentication
        if (!initAuthCheck('admin')) {
            window.location.href = '../index.html'
        }

        // Insert navigation
        insertNav('admin', 'meetings')

        let meetings = []
        let allMeetings = []

        // Load all meetings
        async function loadMeetings() {
            try {
                allMeetings = await getAllMeetingsAdmin()
                meetings = allMeetings
                displayMeetings()
            } catch (error) {
                console.error('Error loading meetings:', error)
                showToast('Failed to load meetings', 'error')
            }
        }

        // Search by date
        async function searchByDate() {
            const searchDate = document.getElementById('search-date').value
            if (!searchDate) {
                showToast('Please select a date', 'error')
                return
            }

            const filtered = allMeetings.filter(meeting => {
                const meetingDate = meeting.meeting_date || meeting.created_at.split('T')[0]
                return meetingDate === searchDate
            })

            meetings = filtered
            displayMeetings()
        }

        // Clear search
        function clearSearch() {
            document.getElementById('search-date').value = ''
            meetings = allMeetings
            displayMeetings()
        }

        // Display meetings
        function displayMeetings() {
            const meetingsList = document.getElementById('meetings-list')

            if (!meetings || meetings.length === 0) {
                meetingsList.innerHTML = '<p class="text-muted">No meetings recorded yet.</p>'
                return
            }

            meetingsList.innerHTML = meetings
                .map(meeting => `
                    <div class="lead-card">
                        <div class="lead-header">
                            <div class="lead-title">
                                <h6>${meeting.meeting_with}</h6>
                                <p class="text-muted small mb-0">${meeting.client_name}</p>
                            </div>
                            <span class="badge bg-success">
                                <i class="fas fa-calendar"></i> ${new Date(meeting.created_at).toLocaleDateString()}
                            </span>
                        </div>

                        <div class="lead-details mt-3">
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">User</span>
                                <span class="lead-detail-value">${meeting.users?.name || meeting.users?.email || 'Unknown'}</span>
                            </div>
                        </div>

                        <div class="mt-3 p-3 bg-light rounded">
                            <p class="mb-2"><strong>Agenda:</strong></p>
                            <p class="mb-0 text-muted">${meeting.agenda}</p>
                        </div>

                        ${meeting.outcome ? `
                            <div class="mt-2 p-3 bg-light rounded">
                                <p class="mb-2"><strong>Outcome:</strong></p>
                                <p class="mb-0 text-muted">${meeting.outcome}</p>
                            </div>
                        ` : ''}
                    </div>
                `)
                .join('')
        }

        // Initialize
        loadMeetings()

        // Auto-refresh every 30 seconds
        setInterval(loadMeetings, 30000)
    </script>
</body>

</html>