<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meetings - Admin - Sales Ops</title>
    <link rel="icon" href="../assets/logo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
    <div id="app">
        <!-- Sidebar will be inserted here -->

        <div class="main-content">
            <div class="page-header flex-wrap gap-3">
                <h2 class="mb-0">All Meetings</h2>
                <div class="d-flex flex-wrap gap-2 w-100-mobile align-items-center">
                    <div class="d-none d-lg-flex gap-2">
                        <input type="date" class="form-control" id="header-search-date" style="width: 150px;"
                            onchange="syncAndSearch('date', this.value)">
                        <input type="text" class="form-control" id="header-search-client" style="width: 150px;"
                            placeholder="Client" oninput="syncAndSearch('client', this.value)">
                    </div>
                    <button class="btn btn-outline-primary w-100-mobile" onclick="exportMeetings()">
                        <i class="fas fa-file-export"></i> Export CSV
                    </button>
                    <button class="btn btn-primary w-100-mobile" data-bs-toggle="modal"
                        data-bs-target="#addMeetingModal">
                        <i class="fas fa-plus"></i> Add Meeting
                    </button>
                </div>
            </div>

            <!-- Search/Filter -->
            <div class="content-card mb-3">
                <div class="row g-3">
                    <div class="col-lg-4 col-md-6">
                        <label class="form-label">Search Date</label>
                        <input type="date" class="form-control" id="search-date">
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <label class="form-label">Search Client</label>
                        <input type="text" class="form-control" id="search-client" placeholder="Client name">
                    </div>
                    <div class="col-lg-4 col-md-12 d-flex align-items-end gap-2">
                        <button class="btn btn-secondary flex-grow-1" onclick="searchMeetings()">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearSearch()">
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <div id="meetings-list" class="leads-container">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Add/Edit Meeting Modal -->
        <div class="modal fade" id="addMeetingModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="meetingModalTitle">Add Meeting</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="meeting-form">
                            <input type="hidden" id="meeting-id">

                            <div class="mb-3">
                                <label for="meeting-with" class="form-label">Meeting with whom</label>
                                <input type="text" class="form-control" id="meeting-with"
                                    placeholder="Enter person's name" required>
                            </div>

                            <div class="mb-3">
                                <label for="meeting-client" class="form-label">Name of the client</label>
                                <input type="text" class="form-control" id="meeting-client"
                                    placeholder="Enter client name" required>
                            </div>

                            <div class="mb-3">
                                <label for="meeting-agenda" class="form-label">Agenda</label>
                                <textarea class="form-control" id="meeting-agenda" rows="3"
                                    placeholder="Enter meeting agenda" required></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="meeting-outcome" class="form-label">Outcome</label>
                                <textarea class="form-control" id="meeting-outcome" rows="3"
                                    placeholder="Enter meeting outcome"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary w-100" id="save-meeting-btn">
                                <i class="fas fa-save"></i> Save Meeting
                                <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="../assets/js/supabase-client.js"></script>
        <script src="../assets/js/auth.js"></script>
        <script src="../assets/js/common.js"></script>
        <script>
            // Check authentication
            if (!initAuthCheck('admin')) {
                window.location.href = '../index.html'
            }

            // Insert navigation
            insertNav('admin', 'meetings')

            const session = getCurrentSession()
            let meetings = []
            let allMeetings = []
            let editingMeetingId = null

            // Load all meetings
            async function loadMeetings() {
                try {
                    allMeetings = await getAllMeetingsAdmin()
                    meetings = allMeetings
                    displayMeetings()
                } catch (error) {
                    console.error('Error loading meetings:', error)
                    showToast('Failed to load meetings', 'error')
                }
            }

            // Search by date and/or client
            async function searchMeetings() {
                const searchDate = document.getElementById('search-date').value
                const searchClient = document.getElementById('search-client').value

                let filtered = allMeetings

                // Filter by date if provided
                if (searchDate) {
                    filtered = filtered.filter(meeting => {
                        const meetingDate = meeting.meeting_date || meeting.created_at.split('T')[0]
                        return meetingDate === searchDate
                    })
                }

                // Filter by client if provided
                if (searchClient) {
                    filtered = filtered.filter(meeting => {
                        return meeting.client_name.toLowerCase().includes(searchClient.toLowerCase()) ||
                            meeting.meeting_with.toLowerCase().includes(searchClient.toLowerCase())
                    })
                }

                meetings = filtered
                displayMeetings()

                if (meetings.length === 0 && (searchDate || searchClient)) {
                    showToast('No meetings found matching your search criteria', 'info')
                }
            }

            // Sync header search with main filters
            function syncAndSearch(type, value) {
                if (type === 'date') {
                    document.getElementById('search-date').value = value
                } else if (type === 'client') {
                    document.getElementById('search-client').value = value
                }
                searchMeetings()
            }

            // Clear search
            function clearSearch() {
                document.getElementById('search-date').value = ''
                document.getElementById('search-client').value = ''
                document.getElementById('header-search-date').value = ''
                document.getElementById('header-search-client').value = ''
                meetings = allMeetings
                displayMeetings()
            }

            // Display meetings
            function displayMeetings() {
                const meetingsList = document.getElementById('meetings-list')

                if (!meetings || meetings.length === 0) {
                    meetingsList.innerHTML = '<p class="text-muted">No meetings recorded yet.</p>'
                    return
                }

                meetingsList.innerHTML = meetings
                    .map(meeting => `
                    <div class="lead-card">
                        <div class="lead-header">
                            <div class="lead-title">
                                <h6>${meeting.meeting_with}</h6>
                                <p class="text-muted small mb-0">${meeting.client_name}</p>
                            </div>
                            <div class="d-flex flex-column align-items-end gap-1">
                                <span class="badge bg-success">
                                    <i class="fas fa-calendar"></i> ${meeting.meeting_date || new Date(meeting.created_at).toLocaleDateString()}
                                </span>
                                <small class="text-muted">by ${meeting.users?.name || meeting.users?.email || 'Unknown'}</small>
                            </div>
                        </div>

                        <div class="mt-3 p-3 bg-light rounded">
                            <p class="mb-2"><strong>Agenda:</strong></p>
                            <p class="mb-0 text-muted">${meeting.agenda}</p>
                        </div>

                        ${meeting.outcome ? `
                            <div class="mt-2 p-3 bg-light rounded">
                                <p class="mb-2"><strong>Outcome:</strong></p>
                                <p class="mb-0 text-muted">${meeting.outcome}</p>
                            </div>
                        ` : ''}

                        <div class="lead-actions mt-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="editMeeting('${meeting.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMeeting('${meeting.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `)
                    .join('')
            }

            // Handle form submission
            document.getElementById('meeting-form').addEventListener('submit', async function (e) {
                e.preventDefault()

                const saveBtn = document.getElementById('save-meeting-btn')
                const spinner = saveBtn.querySelector('.spinner-border')

                saveBtn.disabled = true
                spinner.classList.remove('d-none')

                try {
                    const meetingData = {
                        meetingWith: document.getElementById('meeting-with').value,
                        clientName: document.getElementById('meeting-client').value,
                        agenda: document.getElementById('meeting-agenda').value,
                        outcome: document.getElementById('meeting-outcome').value
                    }

                    if (editingMeetingId) {
                        await updateMeeting(editingMeetingId, meetingData)
                        showToast('Meeting updated successfully!', 'success')
                    } else {
                        await createMeeting(session.userId, meetingData)
                        showToast('Meeting added successfully!', 'success')
                    }

                    // Reset form and close modal
                    this.reset()
                    editingMeetingId = null
                    document.getElementById('meetingModalTitle').textContent = 'Add Meeting'
                    bootstrap.Modal.getInstance(document.getElementById('addMeetingModal')).hide()

                    // Reload meetings
                    await loadMeetings()
                } catch (error) {
                    console.error('Error saving meeting:', error)
                    showToast('Failed to save meeting', 'error')
                } finally {
                    saveBtn.disabled = false
                    spinner.classList.add('d-none')
                }
            })

            // Edit meeting
            window.editMeeting = async function (meetingId) {
                const meeting = meetings.find(m => m.id === meetingId)
                if (!meeting) return

                editingMeetingId = meetingId
                document.getElementById('meetingModalTitle').textContent = 'Edit Meeting'
                document.getElementById('meeting-with').value = meeting.meeting_with
                document.getElementById('meeting-client').value = meeting.client_name
                document.getElementById('meeting-agenda').value = meeting.agenda
                document.getElementById('meeting-outcome').value = meeting.outcome || ''

                new bootstrap.Modal(document.getElementById('addMeetingModal')).show()
            }

            // Delete meeting
            window.deleteMeeting = async function (meetingId) {
                if (!confirm('Are you sure you want to delete this meeting?')) return

                try {
                    await deleteMeeting(meetingId)
                    showToast('Meeting deleted successfully!', 'success')
                    await loadMeetings()
                } catch (error) {
                    console.error('Error deleting meeting:', error)
                    showToast('Failed to delete meeting', 'error')
                }
            }

            // Reset form when modal is closed
            document.getElementById('addMeetingModal').addEventListener('hidden.bs.modal', function () {
                document.getElementById('meeting-form').reset()
                editingMeetingId = null
                document.getElementById('meetingModalTitle').textContent = 'Add Meeting'
            })

            // Initialize
            loadMeetings()

            window.exportMeetings = function () {
                const headers = ['Meeting With', 'Client Name', 'Agenda', 'Outcome', 'User', 'Created'];
                exportToCSV(meetings, 'All_Meetings', headers);
            }

            // Enable Real-time listener for meetings
            function setupRealtimeMeetings() {
                const client = initSupabase()
                if (!client) return

                client
                    .channel('admin-meetings-realtime')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'meetings'
                    }, (payload) => {
                        loadMeetings() // Refresh listing
                        if (payload.eventType === 'INSERT') {
                            showToast('ü§ù A team member scheduled a new meeting', 'info')
                        }
                    })
                    .subscribe()
            }

            // Initialize
            loadMeetings()
            setupRealtimeMeetings()
        </script>
</body>

</html>