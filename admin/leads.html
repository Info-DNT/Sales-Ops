<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Leads - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/crm-styles.css">
</head>

<body>
    <div id="app">
        <div class="main-content">
            <div class="page-header flex-wrap gap-3">
                <h2 class="mb-0">All Leads</h2>
                <div class="d-flex flex-wrap gap-2 w-100-mobile align-items-center">
                    <button class="btn btn-outline-primary flex-grow-1" onclick="exportLeads()">
                        <i class="fas fa-file-export"></i> Export CSV
                    </button>
                    <button class="btn btn-primary w-100-mobile" data-bs-toggle="modal" data-bs-target="#addLeadModal">
                        <i class="fas fa-plus"></i> Add Lead
                    </button>
                </div>
            </div>

            <!-- Search/Filter -->
            <div class="content-card mb-3">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">Search Date/Contact</label>
                        <div class="input-group">
                            <input type="date" class="form-control" id="search-date">
                            <input type="tel" class="form-control" id="search-contact" placeholder="Contact">
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <label class="form-label">Keyword Search</label>
                        <input type="text" class="form-control" id="search-query" placeholder="Name, email, account...">
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="filter-status">
                            <option value="">All Statuses</option>
                            <option value="New">New</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Qualified">Qualified</option>
                            <option value="Closed">Closed</option>
                            <option value="Not Converted">Not Converted</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6 d-flex align-items-end gap-2">
                        <button class="btn btn-secondary flex-grow-1" onclick="applyCombinedAdminFilters()">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearAllAdminFilters()">
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <h5 class="mb-3">All Lead Records</h5>
                <div id="leads-list">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Lead Details Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="leadDetailsOffcanvas" style="width: 500px;">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title" id="details-lead-name">Lead Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <!-- Tabs -->
            <ul class="nav nav-tabs-custom px-4" id="detailsTabs">
                <li><a href="#" class="nav-link active" onclick="switchDetailsTab('overview')">Overview</a></li>
                <li><a href="#" class="nav-link" onclick="switchDetailsTab('timeline')">Timeline</a></li>
            </ul>

            <!-- Content Area -->
            <div class="px-4 pb-4">
                <!-- Overview Tab -->
                <div id="tab-overview" class="details-tab-content">
                    <form id="edit-lead-form">
                        <input type="hidden" id="edit-lead-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Client Name</label>
                                <input type="text" class="form-control" id="edit-lead-name" placeholder="Client Name"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Client Phone</label>
                                <input type="tel" class="form-control" id="edit-lead-contact" placeholder="Client Phone"
                                    required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Client Email</label>
                            <input type="email" class="form-control" id="edit-lead-email" placeholder="Client Email">
                        </div>

                        <hr class="my-3">
                        <h6>Patient Information</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Patient Name</label>
                                <input type="text" class="form-control" id="edit-patient-name"
                                    placeholder="Patient Name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Patient Contact</label>
                                <input type="tel" class="form-control" id="edit-patient-contact"
                                    placeholder="Patient Contact">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Patient Email</label>
                            <input type="email" class="form-control" id="edit-patient-email"
                                placeholder="Patient Email">
                        </div>
                        <hr class="my-3">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-control" id="edit-lead-status">
                                    <option value="New">New</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Closed">Closed</option>
                                    <option value="Not Converted">Not Converted</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Assign To User</label>
                                <select class="form-control" id="edit-lead-owner-select">
                                    <option value="">Loading users...</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Next Action</label>
                            <textarea class="form-control" id="edit-lead-next-action" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Follow-up Date</label>
                                <input type="date" class="form-control" id="edit-lead-follow-up">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Expected Close</label>
                                <input type="date" class="form-control" id="edit-lead-expected-close">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-2" id="save-lead-btn">
                            Save Changes
                        </button>
                    </form>
                </div>


                <!-- Timeline Tab -->
                <div id="tab-timeline" class="details-tab-content d-none">
                    <div id="timeline-container" class="timeline">
                        <!-- Activity items will be inserted here -->
                        <p class="text-muted text-center py-4">Loading history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal fade" id="addLeadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Lead</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-lead-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-name" class="form-label">Client Name</label>
                                <input type="text" class="form-control" id="lead-name" placeholder="Enter client name"
                                    required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lead-contact" class="form-label">Client Phone</label>
                                <input type="tel" class="form-control" id="lead-contact"
                                    placeholder="Enter client phone" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-email" class="form-label">Client Email</label>
                                <input type="email" class="form-control" id="lead-email"
                                    placeholder="Enter client email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lead-owner-select" class="form-label">Lead Owner</label>
                                <select class="form-control" id="lead-owner-select">
                                    <option value="">Loading users...</option>
                                </select>
                            </div>
                        </div>

                        <hr class="my-3">
                        <h6 class="mb-3">Patient Information</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patient-name" class="form-label">Patient Name</label>
                                <input type="text" class="form-control" id="patient-name"
                                    placeholder="Enter patient name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patient-contact" class="form-label">Patient Contact</label>
                                <input type="tel" class="form-control" id="patient-contact"
                                    placeholder="Enter patient contact">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="patient-email" class="form-label">Patient Email</label>
                                <input type="email" class="form-control" id="patient-email"
                                    placeholder="Enter patient email">
                            </div>
                        </div>

                        <hr class="my-3">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-status" class="form-label">Lead Status</label>
                                <select class="form-control" id="lead-status" required>
                                    <option value="New">New</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Closed">Closed</option>
                                    <option value="Not Converted">Not Converted</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lead-source" class="form-label">Lead Source</label>
                                <select class="form-control" id="lead-source">
                                    <option value="">Select Source</option>
                                    <option value="WhatsApp">WhatsApp</option>
                                    <option value="Hospital">Hospital</option>
                                    <option value="Reference">Reference</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Consulates">Consulates</option>
                                    <option value="Embassy">Embassy</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lead-field" class="form-label">Field</label>
                                <select class="form-control" id="lead-field">
                                    <option value="">Select Field</option>
                                    <option value="Medical Tourism">Medical Tourism</option>
                                    <option value="Medical Evacuation">Medical Evacuation</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="follow-up-date" class="form-label">Follow-up Date</label>
                            <input type="date" class="form-control" id="follow-up-date" required>
                        </div>

                        <div class="mb-3">
                            <label for="next-action" class="form-label">Next Action</label>
                            <textarea class="form-control" id="next-action" rows="2"
                                placeholder="Describe next action"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="expected-close" class="form-label">Expected Close Date</label>
                            <input type="date" class="form-control" id="expected-close">
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="add-lead-btn">
                            <i class="fas fa-check"></i> Save Lead
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/zoho-integration.js"></script>
    <script>
        if (!initAuthCheck('admin')) window.location.href = '../index.html'
        insertNav('admin', 'leads')

        const session = getCurrentSession()
        let leads = []
        let allLeads = []
        let editingLeadId = null

        // Load all leads
        async function loadLeads() {
            const container = document.getElementById('leads-list')
            container.innerHTML = '<p class="text-muted">Loading...</p>'

            try {
                allLeads = await getAllLeadsAdmin()
                leads = allLeads
                displayLeads()
            } catch (error) {
                console.error('Error loading leads:', error)
                showToast('Failed to load leads', 'error')
                container.innerHTML = '<p class="text-danger">Error loading leads.</p>'
            }
        }

        // Handle Sync CRM button click
        async function handleSyncCRM() {
            const btn = document.getElementById('sync-crm-btn')
            const icon = btn.querySelector('i')

            // Show syncing state
            btn.classList.add('syncing')
            btn.disabled = true
            icon.classList.add('fa-spin')

            try {
                const result = await syncCRMLeads()

                if (result.success) {
                    showToast(`Synced ${result.totalLeads} CRM leads (${result.newLeads} new)`, 'success')
                    // Reload leads to include CRM leads
                    await loadLeads()
                } else {
                    const errorMsg = result.raw ? `${result.error}: ${result.raw.slice(0, 50)}...` : (result.error || 'Failed to sync CRM leads')
                    showToast(errorMsg, 'error')
                }
            } catch (error) {
                console.error('Error syncing CRM:', error)
                showToast('Error: ' + error.message, 'error')
            } finally {
                // Remove syncing state
                btn.classList.remove('syncing')
                btn.disabled = false
                icon.classList.remove('fa-spin')
            }
        }

        // Search by date and/or contact number
        // Combined filter function for Admin
        function applyCombinedAdminFilters() {
            const searchDate = document.getElementById('search-date').value
            const searchContact = document.getElementById('search-contact').value // Search by Client Phone
            const filterStatus = document.getElementById('filter-status').value
            const searchQuery = document.getElementById('search-query').value.toLowerCase()

            let filtered = allLeads

            if (searchDate) {
                filtered = filtered.filter(lead => {
                    const createdDate = lead.created_at.split('T')[0]
                    return createdDate === searchDate || (lead.follow_up_date && lead.follow_up_date === searchDate) || (lead.lead_date && lead.lead_date === searchDate)
                })
            }

            if (searchContact) {
                filtered = filtered.filter(lead => lead.contact && lead.contact.includes(searchContact))
            }

            if (filterStatus) {
                filtered = filtered.filter(l => l.status === filterStatus)
            }

            if (searchQuery) {
                filtered = filtered.filter(l => {
                    const name = (l.name || '').toLowerCase()
                    const email = (l.email || '').toLowerCase()
                    const account = (l.account_name || '').toLowerCase()
                    const owner = (l.owner || '').toLowerCase()
                    const userName = (l.users?.name || '').toLowerCase()
                    const userEmail = (l.users?.email || '').toLowerCase()

                    return name.includes(searchQuery) ||
                        email.includes(searchQuery) ||
                        account.includes(searchQuery) ||
                        owner.includes(searchQuery) ||
                        userName.includes(searchQuery) ||
                        userEmail.includes(searchQuery)
                })
            }

            leads = filtered
            displayLeads()

            if (leads.length === 0) {
                showToast('No leads found matching your criteria', 'info')
            }
        }

        function clearAllAdminFilters() {
            document.getElementById('search-date').value = ''
            document.getElementById('search-contact').value = ''
            document.getElementById('filter-status').value = ''
            document.getElementById('search-query').value = ''
            leads = allLeads
            displayLeads()
        }

        // Backward compatibility
        function searchLeads() { applyCombinedAdminFilters(); }
        function clearSearch() { clearAllAdminFilters(); }
        function applyFilter() { applyCombinedAdminFilters(); }
        function clearFilter() { clearAllAdminFilters(); }

        function displayLeads() {
            const container = document.getElementById('leads-list')

            if (!leads || leads.length === 0) {
                container.innerHTML = '<p class="text-muted">No leads found.</p>'
                return
            }

            container.innerHTML = leads.map(lead => {
                const isCRM = lead.lead_source && lead.lead_source !== '';

                // 1. Calculate Stale Status (Aging)
                const lastUpdate = new Date(lead.updated_at || lead.created_at);
                const diffDays = Math.floor((new Date() - lastUpdate) / (1000 * 60 * 60 * 24));
                let agingClass = '';
                if (diffDays >= 7) agingClass = 'stale-pulse-danger';
                else if (diffDays >= 3) agingClass = 'stale-pulse-warning';

                // 2. Calculate Follow-up Status (Urgent)
                const today = new Date().toISOString().split('T')[0];
                const isUrgent = lead.follow_up_date && lead.follow_up_date <= today && lead.status !== 'Closed';

                return `
                <div class="lead-card mb-3 ${isCRM ? 'crm-lead' : ''} ${agingClass}" onclick="openLeadDetails('${lead.id}')" style="cursor: pointer;">
                    <div class="lead-header">
                        <div class="lead-title">
                            <h6>
                                ${lead.name}
                                ${isCRM ? '<span class="crm-badge">CRM</span>' : ''}
                                ${isUrgent ? '<span class="urgent-badge"><i class="fas fa-exclamation-circle"></i> Follow-up Due</span>' : ''}
                            </h6>
                            <p class="text-muted small mb-0">
                                <strong>User:</strong> ${lead.users?.name || lead.users?.email || 'Unknown'} | 
                                <strong>Account:</strong> ${lead.account_name || 'N/A'}
                                ${lead.field ? ` | <strong>Field:</strong> ${lead.field}` : ''}
                                ${lead.patient_name ? ` | <strong>Patient:</strong> ${lead.patient_name}` : ''}
                                ${diffDays > 0 ? ` | <span class="${diffDays >= 3 ? 'text-warning fw-bold' : ''}">Activity: ${diffDays}d ago</span>` : ' | <span>Activity: Today</span>'}
                            </p>
                        </div>
                        <span class="lead-status-badge ${lead.status.toLowerCase().replace(' ', '-')}">${lead.status}</span>
                    </div>
                    <div class="lead-details mt-2">
                        <div class="row">
                            <div class="col-md-4">
                                <small><strong>Client Phone:</strong> ${lead.contact || 'N/A'}</small>
                            </div>
                            <div class="col-md-4">
                                <small><strong>Client Email:</strong> ${lead.email || 'N/A'}</small>
                            </div>
                            <div class="col-md-4">
                                <small><strong>Follow-up:</strong> <span class="${isUrgent ? 'text-danger fw-bold' : ''}">${lead.follow_up_date || 'N/A'}</span></small>
                            </div>
                        </div>
                    </div>
                    <div class="lead-actions mt-3">
                        <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); handleDeleteLead('${lead.id}')">Delete</button>
                    </div>
                </div>
            `;
            }).join('')
        }

        function applyFilter() {
            const status = document.getElementById('filter-status').value
            const searchQuery = document.getElementById('search-query').value.toLowerCase()

            let filtered = allLeads

            // Filter by status
            if (status) {
                filtered = filtered.filter(l => l.status === status)
            }

            // Filter by search query
            if (searchQuery) {
                filtered = filtered.filter(l => {
                    const name = (l.name || '').toLowerCase()
                    const email = (l.email || '').toLowerCase()
                    const account = (l.account_name || '').toLowerCase()
                    const owner = (l.owner || '').toLowerCase()
                    const userName = (l.users?.name || '').toLowerCase()
                    const userEmail = (l.users?.email || '').toLowerCase()

                    return name.includes(searchQuery) ||
                        email.includes(searchQuery) ||
                        account.includes(searchQuery) ||
                        owner.includes(searchQuery) ||
                        userName.includes(searchQuery) ||
                        userEmail.includes(searchQuery)
                })
            }

            displayLeads(filtered)
        }

        function clearFilter() { clearAllAdminFilters(); }

        // ===== Lead Assignment Functions =====

        let allUsers = [];

        // Load all users for assignment dropdown
        async function loadAllUsers() {
            const client = initSupabase();
            const { data, error } = await client
                .from('users')
                .select('id, name, email, role')
                .order('name');

            if (error) {
                console.error('Error loading users:', error);
                return [];
            }

            allUsers = data;
            return data;
        }

        // Populate the owner dropdown with users
        async function populateOwnerDropdown(currentUserId) {
            const users = allUsers.length > 0 ? allUsers : await loadAllUsers();
            const editSelect = document.getElementById('edit-lead-owner-select');
            const addSelect = document.getElementById('lead-owner-select');

            const options = users.map(user => `
                <option value="${user.id}" ${user.id === currentUserId ? 'selected' : ''}>
                    ${user.name ? user.name : user.email}${user.role === 'admin' ? ' (Admin)' : ''}
                </option>
            `).join('');

            if (editSelect) editSelect.innerHTML = options;
            if (addSelect) {
                // For add modal, if no user is selected yet, default to current session user
                const defaultOptions = users.map(user => `
                    <option value="${user.id}" ${user.id === (session?.userId || '') ? 'selected' : ''}>
                        ${user.name || user.email}${user.role === 'admin' ? ' (Admin)' : ''}
                    </option>
                `).join('');
                addSelect.innerHTML = defaultOptions;
            }
        }

        // Handle lead assignment to a user
        async function handleLeadAssignment(leadId, newUserId) {
            const client = initSupabase();

            // Get the new user's name
            const user = allUsers.find(u => u.id === newUserId);
            if (!user) {
                showToast('User not found', 'error');
                return false;
            }

            // Update the lead
            const { error } = await client
                .from('leads')
                .update({
                    user_id: newUserId,
                    owner: user.name || user.email
                })
                .eq('id', leadId);

            if (error) {
                console.error('Assignment error:', error);
                showToast('Failed to assign lead', 'error');
                return false;
            }

            showToast(`Lead assigned to ${user.name || user.email}`, 'success');
            return true;
        }

        // Setup real-time listener for new users
        function setupRealtimeUsers() {
            const client = initSupabase();

            client
                .channel('users-updates')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'users'
                }, () => {
                    // Refresh users list
                    loadAllUsers().then(() => {
                        // Update dropdown if modal is open
                        const modalElement = document.getElementById('leadDetailsOffcanvas');
                        if (modalElement && modalElement.classList.contains('show') && editingLeadId) {
                            const currentUserId = document.getElementById('edit-lead-owner-select')?.value;
                            populateOwnerDropdown(currentUserId);
                        }
                    });
                })
                .subscribe();
        }

        async function openLeadDetails(leadId) {
            editingLeadId = leadId;
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) return;

            // Fill overview form
            document.getElementById('details-lead-name').textContent = lead.name;
            document.getElementById('edit-lead-id').value = lead.id;
            document.getElementById('edit-lead-name').value = lead.name;
            document.getElementById('edit-lead-contact').value = lead.contact;
            document.getElementById('edit-lead-email').value = lead.email || '';
            document.getElementById('edit-patient-name').value = lead.patient_name || '';
            document.getElementById('edit-patient-contact').value = lead.patient_contact || '';
            document.getElementById('edit-patient-email').value = lead.patient_email || '';
            document.getElementById('edit-lead-status').value = lead.status;

            // Populate owner dropdown
            populateOwnerDropdown(lead.user_id);

            document.getElementById('edit-lead-next-action').value = lead.next_action || '';
            document.getElementById('edit-lead-follow-up').value = lead.follow_up_date || '';
            document.getElementById('edit-lead-expected-close').value = lead.expected_close || '';

            // Switch to overview tab by default
            switchDetailsTab('overview');

            // Show offcanvas
            const offcanvasElement = document.getElementById('leadDetailsOffcanvas');
            const offcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement) || new bootstrap.Offcanvas(offcanvasElement);
            offcanvas.show();

            // Load history
            loadLeadHistory(leadId);
        }

        function switchDetailsTab(tab) {
            const overviewTab = document.getElementById('tab-overview');
            const timelineTab = document.getElementById('tab-timeline');
            const links = document.querySelectorAll('#detailsTabs .nav-link');

            if (tab === 'overview') {
                overviewTab.classList.remove('d-none');
                timelineTab.classList.add('d-none');
                links[0].classList.add('active');
                links[1].classList.remove('active');
            } else {
                overviewTab.classList.add('d-none');
                timelineTab.classList.remove('d-none');
                links[0].classList.remove('active');
                links[1].classList.add('active');
            }
        }

        async function loadLeadHistory(leadId) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '<p class="text-muted text-center py-4">Loading history...</p>';

            try {
                const history = await getLeadHistory(leadId);
                if (!history || history.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center py-4">No activity yet.</p>';
                    return;
                }

                container.innerHTML = history.map(item => `
                    <div class="timeline-item">
                        <div class="timeline-dot">
                            <i class="fas ${item.action.includes('Created') ? 'fa-plus' : 'fa-edit'}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-time">${new Date(item.created_at).toLocaleString()}</div>
                            <div class="timeline-title">${item.action}</div>
                            <div class="timeline-desc">${item.details.summary || item.details.status || (item.details.changes ? item.details.changes.join(', ') : '') || ''}</div>
                            <div class="small text-muted mt-1">by ${item.users?.name || item.users?.email || 'User'}</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading history:', error);
                container.innerHTML = '<p class="text-danger text-center py-4">Error loading history.</p>';
            }
        }

        document.getElementById('edit-lead-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const saveBtn = document.getElementById('save-lead-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Saving...';

            try {
                const selectedUserId = document.getElementById('edit-lead-owner-select').value;
                const selectedUser = allUsers.find(u => u.id === selectedUserId);
                const ownerName = selectedUser ? (selectedUser.name || selectedUser.email) : 'Unknown';

                const updates = {
                    name: document.getElementById('edit-lead-name').value,
                    contact: document.getElementById('edit-lead-contact').value,
                    email: document.getElementById('edit-lead-email').value,
                    status: document.getElementById('edit-lead-status').value,
                    owner: ownerName,
                    userId: selectedUserId,
                    nextAction: document.getElementById('edit-lead-next-action').value,
                    followUpDate: document.getElementById('edit-lead-follow-up').value || null,
                    expectedClose: document.getElementById('edit-lead-expected-close').value || null,
                    patientName: document.getElementById('edit-patient-name').value,
                    patientContact: document.getElementById('edit-patient-contact').value,
                    patientEmail: document.getElementById('edit-patient-email').value
                };

                await updateLead(editingLeadId, updates, session.userId);
                showToast('Lead updated successfully', 'success');

                // Refresh list
                await loadLeads();

                // Refresh history tab
                loadLeadHistory(editingLeadId);

                // Close modal
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('leadDetailsOffcanvas'));
                if (offcanvas) offcanvas.hide();

            } catch (error) {
                console.error('Error updating lead:', error);
                showToast('Failed to update lead', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        })

        // Delete lead
        async function handleDeleteLead(leadId) {
            if (!confirm('Are you sure you want to delete this lead?')) {
                return
            }

            try {
                await deleteLead(leadId)
                showToast('Lead deleted successfully', 'success')
                loadLeads()
            } catch (error) {
                console.error('Error deleting lead:', error)
                showToast('Failed to delete lead', 'error')
            }
        }


        // Create lead form submission
        document.getElementById('add-lead-form').addEventListener('submit', async function (e) {
            e.preventDefault()

            const addBtn = document.getElementById('add-lead-btn')
            const spinner = addBtn.querySelector('.spinner-border')

            addBtn.disabled = true
            spinner.classList.remove('d-none')

            try {
                const selectedUserId = document.getElementById('lead-owner-select').value;
                const selectedUser = allUsers.find(u => u.id === selectedUserId);
                const ownerName = selectedUser ? (selectedUser.name || selectedUser.email) : 'Unknown';

                const lead = {
                    name: document.getElementById('lead-name').value,
                    contact: document.getElementById('lead-contact').value,
                    email: document.getElementById('lead-email').value,
                    owner: ownerName,
                    status: document.getElementById('lead-status').value,
                    leadSource: document.getElementById('lead-source').value,
                    leadField: document.getElementById('lead-field').value,
                    followUpDate: document.getElementById('follow-up-date').value || null,
                    nextAction: document.getElementById('next-action').value,
                    expectedClose: document.getElementById('expected-close').value || null,
                    patientName: document.getElementById('patient-name').value,
                    patientContact: document.getElementById('patient-contact').value,
                    patientEmail: document.getElementById('patient-email').value
                }

                if (!session || !session.userId) {
                    throw new Error('No active session found. Please login again.')
                }

                await createLead(selectedUserId, lead)

                // Reset form and close modal
                this.reset()
                bootstrap.Modal.getInstance(document.getElementById('addLeadModal')).hide()

                showToast('Lead added successfully!', 'success')

                // Reload list
                await loadLeads()
            } catch (error) {
                console.error('Error adding lead:', error)
                showToast('Failed to add lead', 'error')
            } finally {
                addBtn.disabled = false
                spinner.classList.add('d-none')
            }
        })
        loadLeads()
        loadAllUsers().then(() => {
            populateOwnerDropdown();
        })
        setupRealtimeUsers()

        window.exportLeads = function () {
            const headers = ['Client Name', 'Client Phone', 'Client Email', 'Patient Name', 'Patient Phone', 'Patient Email', 'Status', 'User', 'Created'];
            const dataToExport = leads.map(l => ({
                'Client Name': l.name,
                'Client Phone': l.contact,
                'Client Email': l.email,
                'Patient Name': l.patient_name || '',
                'Patient Phone': l.patient_contact || '',
                'Patient Email': l.patient_email || '',
                'Status': l.status,
                'User': l.users?.name || l.users?.email || 'Unknown',
                'Created': new Date(l.created_at).toLocaleString()
            }));
            exportToCSV(dataToExport, 'All_Leads', headers);
        }

        // Enable Real-time listener for leads
        function setupRealtimeLeads() {
            const client = initSupabase()
            if (!client) return

            client
                .channel('leads-all')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'leads'
                }, (payload) => {
                    // console.log('Real-time update received:', payload)
                    loadLeads() // Refresh the list

                    if (payload.eventType === 'INSERT') {
                        showToast('New lead received from CRM!', 'info')
                    }
                })
                .subscribe()
        }

        setupRealtimeLeads()

    </script>
</body>

</html>