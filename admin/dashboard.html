<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sales Ops</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/crm-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="app">
        <!-- Sidebar will be inserted here -->

        <div class="main-content">
            <div class="page-header">
                <h2>Admin Dashboard</h2>
                <div class="d-flex align-items-center gap-3">
                    <div class="text-muted small">System-wide Overview</div>
                    <button class="btn btn-primary d-none-quotation" data-bs-toggle="modal"
                        data-bs-target="#quotationModal">
                        <i class="fas fa-file-invoice-dollar"></i> Request Quotation
                    </button>
                </div>
            </div>

            <div class="dashboard-grid-horizontal">
                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="total-users">0</div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(236, 72, 153, 0.1); color: #ec4899;">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-value" id="total-leads">0</div>
                </div>

                <div class="stat-card-modern d-none-quotation">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-label">Quotations</div>
                    <div class="stat-value" id="total-quotations">0</div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-label">Active Today</div>
                    <div class="stat-value" id="active-today">0</div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(6, 182, 212, 0.1); color: #06b6d4;">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="stat-label">Total Calls</div>
                    <div class="stat-value" id="total-calls">0</div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="stat-label">Total Meetings</div>
                    <div class="stat-value" id="total-meetings">0</div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-5">
                    <div class="saas-card">
                        <div class="saas-card-header">
                            <h5><i class="fas fa-chart-pie text-primary me-2"></i> Lead Pipeline</h5>
                        </div>
                        <div class="saas-card-body">
                            <div style="height: 300px; position: relative;">
                                <canvas id="adminPipelineChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="saas-card">
                        <div class="saas-card-header">
                            <h5><i class="fas fa-chart-bar text-success me-2"></i> Team Activity (Last 7 Days)</h5>
                        </div>
                        <div class="saas-card-body">
                            <div style="height: 300px; position: relative;">
                                <canvas id="adminActivityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="saas-card">
                        <div class="saas-card-header">
                            <h5>
                                <i class="fas fa-bell text-danger me-2"></i> Pending Follow-ups
                                <span id="reminder-count" class="badge bg-danger ms-2 d-none">0</span>
                            </h5>
                        </div>
                        <div class="saas-card-body" id="reminders-list">
                            <p class="text-muted small">Checking for system reminders...</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="saas-card">
                        <div class="saas-card-header">
                            <h5><i class="fas fa-users text-primary me-2"></i> Recent Leads</h5>
                        </div>
                        <div class="saas-card-body" id="recent-leads">
                            <p class="text-muted small">Loading leads...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Request Quotation Modal -->
        <div class="modal fade" id="quotationModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Request Quotation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Embedded Zoho Form -->
                        <iframe src="https://zfrmz.in/KYafI4HZrgOZRwy4zKaU"
                            style="width: 100%; min-height: 600px; border: none;" frameborder="0" allowfullscreen>
                        </iframe>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="../assets/js/supabase-client.js"></script>
        <script src="../assets/js/auth.js"></script>
        <script src="../assets/js/common.js"></script>
        <script>
            // Check authentication
            if (!initAuthCheck('admin')) {
                window.location.href = '../index.html'
            }

            // Insert navigation
            insertNav('admin', 'dashboard')

            // Load dashboard data
            async function updateDashboard() {
                try {
                    // Get stats from Supabase
                    const stats = await getAdminDashboardStats()

                    // Update stats cards
                    document.getElementById('total-users').textContent = stats.totalUsers
                    document.getElementById('total-leads').textContent = stats.totalLeads
                    document.getElementById('total-quotations').textContent = stats.totalQuotations
                    document.getElementById('active-today').textContent = stats.activeToday
                    document.getElementById('total-calls').textContent = stats.totalCalls
                    document.getElementById('total-meetings').textContent = stats.totalMeetings

                    // Display recent leads
                    await displayRecentLeads()

                    // Render Analytics
                    const allLeads = await getAllLeadsAdmin()
                    const allCalls = await getAllCallsAdmin()
                    const allMeetings = await getAllMeetingsAdmin()
                    updateAdminCharts(allLeads, allCalls, allMeetings)

                } catch (error) {
                    console.error('Error loading dashboard:', error)
                }
            }

            function updateAdminCharts(leads, calls, meetings) {
                // Pipeline Chart (Doughnut)
                const statusCounts = { 'New': 0, 'In Progress': 0, 'Qualified': 0, 'Closed': 0, 'Not Converted': 0 }
                leads.forEach(l => { if (statusCounts.hasOwnProperty(l.status)) statusCounts[l.status]++ })

                const pipelineCtx = document.getElementById('adminPipelineChart').getContext('2d')
                if (window.pipelineChart) window.pipelineChart.destroy()
                window.pipelineChart = new Chart(pipelineCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#6366f1', '#f59e0b', '#10b981', '#64748b', '#ef4444'],
                            borderWidth: 0,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: { family: "'Inter', sans-serif", size: 12 }
                                }
                            }
                        },
                        cutout: '75%'
                    }
                })

                // Activity Chart (Bar) - Last 7 Days
                const last7Days = []
                for (let i = 6; i >= 0; i--) {
                    const d = new Date()
                    d.setDate(d.getDate() - i)
                    last7Days.push(d.toISOString().split('T')[0])
                }

                const dailyCalls = last7Days.map(date => calls.filter(c => c.created_at.startsWith(date)).length)
                const dailyMeetings = last7Days.map(date => meetings.filter(m => m.created_at.startsWith(date)).length)

                const activityCtx = document.getElementById('adminActivityChart').getContext('2d')
                if (window.activityChart) window.activityChart.destroy()
                window.activityChart = new Chart(activityCtx, {
                    type: 'bar',
                    data: {
                        labels: last7Days.map(d => {
                            const date = new Date(d);
                            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        }),
                        datasets: [
                            {
                                label: 'Calls',
                                data: dailyCalls,
                                backgroundColor: '#6366f1',
                                borderRadius: 6,
                                barThickness: 15
                            },
                            {
                                label: 'Meetings',
                                data: dailyMeetings,
                                backgroundColor: '#10b981',
                                borderRadius: 6,
                                barThickness: 15
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1, font: { family: "'Inter', sans-serif" } },
                                grid: { borderDash: [5, 5], drawBorder: false }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { family: "'Inter', sans-serif" } }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: { family: "'Inter', sans-serif", size: 12 }
                                }
                            }
                        }
                    }
                })
            }

            async function displayRecentLeads() {
                const leadsContainer = document.getElementById('recent-leads')

                try {
                    const allLeads = await getAllLeadsAdmin()

                    // Display reminders
                    displayReminders(allLeads)

                    if (!allLeads || allLeads.length === 0) {
                        leadsContainer.innerHTML = '<p class="text-muted">No leads yet.</p>'
                        return
                    }

                    const recentLeads = allLeads.slice(0, 5)

                    leadsContainer.innerHTML = recentLeads
                        .map(lead => {
                            const statusClass = lead.status.toLowerCase().replace(' ', '-');
                            const isCRM = lead.lead_source && lead.lead_source !== '';
                            return `
                            <div class="saas-list-item ${isCRM ? 'crm-lead' : ''}">
                                <div class="saas-list-item-icon">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="saas-list-item-content flex-grow-1">
                                    <h6>
                                        ${lead.name}
                                        ${isCRM ? '<span class="crm-badge">CRM</span>' : ''}
                                    </h6>
                                    <p>${lead.users?.name || 'Unassigned'} • ${new Date(lead.created_at).toLocaleDateString()}</p>
                                </div>
                                <span class="status-badge-soft ${statusClass}">${lead.status}</span>
                            </div>
                        `;
                        })
                        .join('')
                } catch (error) {
                    console.error('Error loading leads:', error)
                    leadsContainer.innerHTML = '<p class="text-muted">Error loading leads.</p>'
                }
            }

            async function displayReminders(allLeads) {
                const reminderContainer = document.getElementById('reminders-list')
                const reminderCountBadge = document.getElementById('reminder-count')

                const today = new Date().toISOString().split('T')[0]

                const reminders = allLeads.filter(lead => {
                    if (!lead.follow_up_date) return false
                    return lead.follow_up_date <= today && lead.status !== 'Qualified' && lead.status !== 'Lost'
                }).sort((a, b) => new Date(a.follow_up_date) - new Date(b.follow_up_date))

                if (reminders.length === 0) {
                    reminderContainer.innerHTML = '<p class="text-muted">No urgent follow-ups across the system. Everything is on track.</p>'
                    reminderCountBadge.classList.add('d-none')
                    return
                }

                reminderCountBadge.textContent = reminders.length
                reminderCountBadge.classList.remove('d-none')

                reminderContainer.innerHTML = reminders
                    .map(lead => {
                        const isOverdue = lead.follow_up_date < today
                        return `
                        <div class="saas-list-item" style="cursor: pointer;" onclick="window.location.href='leads.html?search=${encodeURIComponent(lead.name)}'">
                            <div class="saas-list-item-icon" style="background: ${isOverdue ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; color: ${isOverdue ? '#ef4444' : '#f59e0b'};">
                                <i class="fas ${isOverdue ? 'fa-calendar-times' : 'fa-calendar-day'}"></i>
                            </div>
                            <div class="saas-list-item-content flex-grow-1">
                                <h6>${lead.name}</h6>
                                <p class="${isOverdue ? 'text-danger fw-bold' : ''}">
                                    ${isOverdue ? 'Overdue' : 'Due today'}: ${new Date(lead.follow_up_date).toLocaleDateString()} • ${lead.users?.name || 'Team'}
                                </p>
                            </div>
                            <i class="fas fa-chevron-right text-muted small"></i>
                        </div>
                    `
                    })
                    .join('')
            }

            // Initialize dashboard
            updateDashboard()

            // Auto-refresh every 30 seconds
            setInterval(updateDashboard, 30000)
        </script>
</body>

</html>