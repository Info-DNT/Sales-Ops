<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Cases - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/crm-styles.css">
</head>

<body>
    <div id="app">
        <!-- Sidebar will be inserted here -->

        <div class="main-content">
            <div class="page-header flex-wrap gap-3">
                <div>
                    <h2 class="mb-0">All Cases</h2>
                    <p class="text-muted small mb-0">System-wide case overview and management</p>
                </div>
                <div class="d-flex flex-wrap gap-2 w-100-mobile align-items-center">
                    <button class="btn btn-outline-primary" onclick="exportCases()">
                        <i class="fas fa-file-export"></i> Upload Cases
                    </button>
                    <button class="btn btn-primary w-100-mobile" data-bs-toggle="modal" data-bs-target="#addCaseModal">
                        <i class="fas fa-plus"></i> Create Case
                    </button>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="dashboard-grid-horizontal mb-4">
                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div class="stat-label">Total Cases</div>
                    <div class="stat-value" id="stats-total">0</div>
                    <div class="text-muted small">All time</div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-label">Completed</div>
                    <div class="stat-value" id="stats-completed">0</div>
                    <div class="text-muted small" id="stats-completed-percent">0%</div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-label">Pending</div>
                    <div class="stat-value" id="stats-pending">0</div>
                    <div class="text-muted small">Requires action</div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(107, 114, 128, 0.1); color: #6b7280;">
                        <i class="fas fa-pause-circle"></i>
                    </div>
                    <div class="stat-label">On Hold</div>
                    <div class="stat-value" id="stats-onhold">0</div>
                    <div class="text-muted small">Awaiting updates</div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-label">Cancelled</div>
                    <div class="stat-value" id="stats-cancelled">0</div>
                    <div class="text-muted small">Closed</div>
                </div>
            </div>

            <!-- Search/Filter -->
            <div class="content-card mb-3">
                <div class="row g-3">
                    <div class="col-lg-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" id="search-query"
                                placeholder="Search cases..." oninput="filterCases()">
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <select class="form-select" id="filter-status" onchange="filterCases()">
                            <option value="">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-lg-3">
                        <select class="form-select" id="filter-priority" onchange="filterCases()">
                            <option value="">All Priorities</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <div id="cases-list-container">
                    <div class="text-center py-5" id="no-cases-message">
                        <p class="text-muted mb-0">No cases found</p>
                    </div>
                    <div id="cases-list" class="leads-container">
                        <!-- Case cards will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Case Details Offcanvas (Edit/View) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="caseDetailsOffcanvas" style="width: 500px;">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title" id="details-case-title">Case Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <form id="edit-case-form">
                <input type="hidden" id="edit-case-id">
                <div class="mb-3">
                    <label class="form-label">Case Title</label>
                    <input type="text" class="form-control" id="edit-case-title" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="edit-case-description" rows="4"></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="edit-case-status">
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="edit-case-priority">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Assign To User</label>
                        <select class="form-select" id="edit-case-user">
                            <option value="">Loading users...</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Link to Lead</label>
                        <select class="form-select" id="edit-case-lead">
                            <option value="">None / Loading leads...</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-2" id="save-case-btn">
                    Save Changes
                </button>
            </form>
        </div>
    </div>

    <!-- Add Case Modal -->
    <div class="modal fade" id="addCaseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Case</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-case-form">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="case-title"
                                placeholder="Brief summary of the case" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="case-description" rows="3"
                                placeholder="Provide more details..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="case-status" required>
                                    <option value="Pending" selected>Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="On Hold">On Hold</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="case-priority" required>
                                    <option value="Low">Low</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Assign To</label>
                                <select class="form-select" id="case-user-select" required>
                                    <option value="">Select User</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Lead (Optional)</label>
                                <select class="form-select" id="case-lead-select">
                                    <option value="">None</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-2" id="add-case-btn">
                            Create Case
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/common.js"></script>
    <script>
        // Check auth
        if (!initAuthCheck('admin')) {
            window.location.href = '../index.html';
        }

        // Insert Nav
        insertNav('admin', 'cases');

        let allCases = [];
        let filteredCases = [];
        let allLeads = [];
        let allUsers = [];
        let editingCaseId = null;

        // Load data
        async function loadData() {
            try {
                const [casesData, leadsData, usersData] = await Promise.all([
                    getAllCasesAdmin(),
                    getAllLeadsAdmin(),
                    getUsersAdmin()
                ]);

                allCases = casesData;
                allLeads = leadsData;
                allUsers = usersData;

                populateDropdowns();
                updateStats();
                filterCases();
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Failed to load data', 'error');
            }
        }

        function populateDropdowns() {
            const userOptions = allUsers.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
            const leadOptions = '<option value="">None</option>' + allLeads.map(l => `<option value="${l.id}">${l.name} (${l.account_name || 'N/A'})</option>`).join('');

            document.getElementById('case-user-select').innerHTML = '<option value="">Select User</option>' + userOptions;
            document.getElementById('edit-case-user').innerHTML = userOptions;

            document.getElementById('case-lead-select').innerHTML = leadOptions;
            document.getElementById('edit-case-lead').innerHTML = leadOptions;
        }

        function updateStats() {
            const total = allCases.length;
            const completed = allCases.filter(c => c.status === 'Completed').length;
            const pending = allCases.filter(c => c.status === 'Pending' || c.status === 'In Progress').length;
            const onhold = allCases.filter(c => c.status === 'On Hold').length;
            const cancelled = allCases.filter(c => c.status === 'Cancelled').length;

            document.getElementById('stats-total').textContent = total;
            document.getElementById('stats-completed').textContent = completed;
            document.getElementById('stats-pending').textContent = pending;
            document.getElementById('stats-onhold').textContent = onhold;
            document.getElementById('stats-cancelled').textContent = cancelled;

            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('stats-completed-percent').textContent = `${percent}%`;
        }

        function filterCases() {
            const query = document.getElementById('search-query').value.toLowerCase();
            const status = document.getElementById('filter-status').value;
            const priority = document.getElementById('filter-priority').value;

            filteredCases = allCases.filter(c => {
                const matchesQuery = !query ||
                    c.title.toLowerCase().includes(query) ||
                    c.description?.toLowerCase().includes(query) ||
                    c.case_number.toLowerCase().includes(query) ||
                    (c.leads?.name && c.leads.name.toLowerCase().includes(query));

                const matchesStatus = !status || c.status === status;
                const matchesPriority = !priority || c.priority === priority;

                return matchesQuery && matchesStatus && matchesPriority;
            });

            displayCases();
        }

        function displayCases() {
            const list = document.getElementById('cases-list');
            const noCases = document.getElementById('no-cases-message');

            if (filteredCases.length === 0) {
                list.innerHTML = '';
                noCases.classList.remove('d-none');
                return;
            }

            noCases.classList.add('d-none');
            list.innerHTML = filteredCases.map(c => `
                <div class="lead-card">
                    <div class="lead-header">
                        <div class="lead-title">
                            <h6><span class="text-primary small me-2">#${c.case_number}</span>${c.title}</h6>
                            <p class="text-muted small mb-0">Assigned: ${c.users?.name || c.users?.email || 'N/A'}</p>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge ${getPriorityBadge(c.priority)}">${c.priority}</span>
                            <span class="badge ${getStatusBadge(c.status)}">${c.status}</span>
                        </div>
                    </div>

                    <div class="lead-details mt-3">
                        ${c.leads ? `
                        <div class="lead-detail-item">
                            <span class="lead-detail-label">Linked Lead</span>
                            <span class="lead-detail-value text-primary">${c.leads.name}</span>
                        </div>
                        ` : ''}
                        <div class="lead-detail-item">
                            <span class="lead-detail-label">Created</span>
                            <span class="lead-detail-value">${new Date(c.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="mt-2 small text-muted text-truncate" style="max-height: 40px;">
                            ${c.description || 'No description provided.'}
                        </div>
                    </div>

                    <div class="lead-actions mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="openCaseDetails('${c.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteCase('${c.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'Completed': return 'bg-success';
                case 'Pending': return 'bg-warning text-dark';
                case 'In Progress': return 'bg-info text-white';
                case 'On Hold': return 'bg-secondary';
                case 'Cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function getPriorityBadge(priority) {
            switch (priority) {
                case 'High': return 'bg-danger';
                case 'Medium': return 'bg-warning text-dark';
                case 'Low': return 'bg-info text-white';
                default: return 'bg-secondary';
            }
        }

        // CRUD Operations
        document.getElementById('add-case-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('add-case-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Creating...';

            try {
                await createCase({
                    title: document.getElementById('case-title').value,
                    description: document.getElementById('case-description').value,
                    status: document.getElementById('case-status').value,
                    priority: document.getElementById('case-priority').value,
                    userId: document.getElementById('case-user-select').value,
                    leadId: document.getElementById('case-lead-select').value
                });

                showToast('Case created successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addCaseModal')).hide();
                e.target.reset();
                loadData();
            } catch (err) {
                console.error(err);
                showToast('Failed to create case', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Case';
            }
        });

        window.openCaseDetails = (id) => {
            const c = allCases.find(x => x.id === id);
            if (!c) return;

            editingCaseId = id;
            document.getElementById('edit-case-id').value = c.id;
            document.getElementById('edit-case-title').value = c.title;
            document.getElementById('edit-case-description').value = c.description || '';
            document.getElementById('edit-case-status').value = c.status;
            document.getElementById('edit-case-priority').value = c.priority;
            document.getElementById('edit-case-user').value = c.user_id;
            document.getElementById('edit-case-lead').value = c.lead_id || '';

            const offcanvas = new bootstrap.Offcanvas(document.getElementById('caseDetailsOffcanvas'));
            offcanvas.show();
        };

        document.getElementById('edit-case-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-case-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Saving...';

            try {
                await updateCase(editingCaseId, {
                    title: document.getElementById('edit-case-title').value,
                    description: document.getElementById('edit-case-description').value,
                    status: document.getElementById('edit-case-status').value,
                    priority: document.getElementById('edit-case-priority').value,
                    userId: document.getElementById('edit-case-user').value,
                    leadId: document.getElementById('edit-case-lead').value
                });

                showToast('Case updated successfully', 'success');
                bootstrap.Offcanvas.getInstance(document.getElementById('caseDetailsOffcanvas')).hide();
                loadData();
            } catch (err) {
                console.error(err);
                showToast('Failed to update case', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        });

        window.handleDeleteCase = async (id) => {
            if (!confirm('Are you sure you want to delete this case?')) return;

            try {
                await deleteCase(id);
                showToast('Case deleted successfully', 'success');
                loadData();
            } catch (err) {
                console.error(err);
                showToast('Failed to delete case', 'error');
            }
        };

        // Initialize
        loadData();
    </script>
</body>

</html>