<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calls - Admin - Sales Ops</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
    <div id="app">
        <!-- Sidebar will be inserted here -->

        <div class="main-content">
            <div class="page-header">
                <h2>All Calls</h2>
                <div class="d-flex gap-2">
                    <input type="date" class="form-control" id="search-date" style="width: 200px;">
                    <input type="tel" class="form-control" id="search-phone" style="width: 200px;"
                        placeholder="Search by phone">
                    <button class="btn btn-secondary" onclick="searchCalls()">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>

            <div class="content-card">
                <div id="calls-list" class="leads-container">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/common.js"></script>
    <script>
        // Check authentication
        if (!initAuthCheck('admin')) {
            window.location.href = '../index.html'
        }

        // Insert navigation
        insertNav('admin', 'calls')

        let calls = []
        let allCalls = []

        // Load all calls
        async function loadCalls() {
            try {
                allCalls = await getAllCallsAdmin()
                calls = allCalls
                displayCalls()
            } catch (error) {
                console.error('Error loading calls:', error)
                showToast('Failed to load calls', 'error')
            }
        }

        // Search by date and/or phone
        async function searchCalls() {
            const searchDate = document.getElementById('search-date').value
            const searchPhone = document.getElementById('search-phone').value

            if (!searchDate && !searchPhone) {
                showToast('Please enter a date or phone number to search', 'error')
                return
            }

            let filtered = allCalls

            // Filter by date if provided
            if (searchDate) {
                filtered = filtered.filter(call => {
                    const callDate = call.call_date || call.created_at.split('T')[0]
                    return callDate === searchDate
                })
            }

            // Filter by phone if provided
            if (searchPhone) {
                filtered = filtered.filter(call => {
                    return call.phone.includes(searchPhone)
                })
            }

            calls = filtered
            displayCalls()

            if (calls.length === 0) {
                showToast('No calls found matching your search criteria', 'info')
            }
        }

        // Clear search
        function clearSearch() {
            document.getElementById('search-date').value = ''
            document.getElementById('search-phone').value = ''
            calls = allCalls
            displayCalls()
        }

        // Display calls
        function displayCalls() {
            const callsList = document.getElementById('calls-list')

            if (!calls || calls.length === 0) {
                callsList.innerHTML = '<p class="text-muted">No calls recorded yet.</p>'
                return
            }

            callsList.innerHTML = calls
                .map(call => `
                    <div class="lead-card">
                        <div class="lead-header">
                            <div class="lead-title">
                                <h6>${call.name}</h6>
                                <p class="text-muted small mb-0">${call.hospital_name}</p>
                            </div>
                            <span class="badge bg-primary">${call.designation}</span>
                        </div>

                        <div class="lead-details mt-3">
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Phone</span>
                                <span class="lead-detail-value">${call.phone}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">User</span>
                                <span class="lead-detail-value">${call.users?.name || call.users?.email || 'Unknown'}</span>
                            </div>
                            <div class="lead-detail-item">
                                <span class="lead-detail-label">Created</span>
                                <span class="lead-detail-value">${new Date(call.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                `)
                .join('')
        }

        // Initialize
        loadCalls()

        // Auto-refresh every 30 seconds
        setInterval(loadCalls, 30000)
    </script>
</body>

</html>